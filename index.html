<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>IELTS AI - Production</title>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .map-container svg { width: 100%; height: auto; border-radius: 8px; }
        .fade-enter-active, .fade-leave-active { transition: opacity 0.5s; }
        .fade-enter-from, .fade-leave-to { opacity: 0; }
    </style>
</head>
<body class="bg-gray-100 font-sans text-gray-800">
    <div id="app" class="min-h-screen flex flex-col">
        
        <nav class="bg-blue-800 text-white p-4 shadow-md flex justify-between items-center">
            <h1 class="text-xl font-bold">IELTS AI <span class="text-xs bg-blue-600 px-2 py-1 rounded">Beta</span></h1>
            <div v-if="user">
                <span class="mr-4">Hi, {{ user }}</span>
                <button @click="logout" class="bg-red-500 hover:bg-red-600 px-3 py-1 rounded text-sm">Logout</button>
            </div>
        </nav>

        <main class="flex-grow p-4 md:p-8 max-w-5xl mx-auto w-full">
            
            <div v-if="!user" class="max-w-md mx-auto bg-white p-8 rounded shadow">
                <h2 class="text-2xl font-bold mb-4">Login</h2>
                <input v-model="loginForm.username" type="text" placeholder="Username" class="w-full mb-3 p-2 border rounded">
                <input v-model="loginForm.password" type="password" placeholder="Password" class="w-full mb-4 p-2 border rounded">
                <button @click="doLogin" :disabled="loading" class="w-full bg-blue-600 text-white p-2 rounded hover:bg-blue-700">
                    {{ loading ? 'Loading...' : 'Login / Register' }}
                </button>
            </div>

            <div v-else-if="view === 'dashboard'" class="grid gap-6">
                <div class="bg-white p-6 rounded shadow grid grid-cols-2 gap-4">
                    <div>
                        <h3 class="font-bold text-lg mb-2">Modes</h3>
                        <div class="space-y-2">
                            <button @click="startExam('skill', 'reading')" class="block w-full text-left p-2 bg-green-50 hover:bg-green-100 rounded border border-green-200">üìö Practice Reading</button>
                            <button @click="startExam('skill', 'listening')" class="block w-full text-left p-2 bg-yellow-50 hover:bg-yellow-100 rounded border border-yellow-200">üéß Practice Listening</button>
                            <button @click="startExam('skill', 'writing')" class="block w-full text-left p-2 bg-purple-50 hover:bg-purple-100 rounded border border-purple-200">‚úçÔ∏è Practice Writing</button>
                            <button @click="startExam('skill', 'speaking')" class="block w-full text-left p-2 bg-pink-50 hover:bg-pink-100 rounded border border-pink-200">üé§ Practice Speaking</button>
                        </div>
                    </div>
                    <div>
                        <button @click="startExam('fullmock')" class="w-full py-4 bg-indigo-600 text-white font-bold rounded shadow hover:bg-indigo-700 mb-4">
                            Start Full Mock Exam
                        </button>
                        <button @click="view = 'history'" class="text-blue-600 underline text-sm">View History</button>
                        <button @click="view = 'settings'" class="text-blue-600 underline text-sm ml-4">Settings</button>
                    </div>
                </div>
            </div>

            <div v-else-if="view === 'exam'" class="bg-white p-6 rounded shadow min-h-[500px]">
                <div v-if="loading" class="text-center py-20">
                    <div class="text-4xl animate-bounce mb-4">ü§ñ</div>
                    <p>AI is generating a unique exam based on your history...</p>
                    <p class="text-sm text-gray-500 mt-2">Checking fingerprints, semantic rotation, and map templates.</p>
                </div>
                
                <div v-else class="h-full flex flex-col">
                    <div class="flex justify-between border-b pb-2 mb-4">
                        <span class="font-bold uppercase">{{ currentExam.mode }} - {{ currentExam.skill || 'ALL' }}</span>
                        <span class="text-red-500 font-mono">{{ timerDisplay }}</span>
                    </div>

                    <div class="flex-grow overflow-y-auto space-y-8">
                        <div v-for="(q, idx) in currentExam.questions" :key="q.id" class="border p-4 rounded bg-gray-50">
                            <div class="font-bold mb-2">Q{{ idx + 1 }}. ({{ q.skill }})</div>
                            
                            <div v-if="q.skill === 'listening'" class="mb-4">
                                <div class="flex items-center gap-2 mb-2">
                                    <button @click="playTTS(q.audioScript)" class="bg-blue-500 text-white px-3 py-1 rounded text-sm">‚ñ∂ Play Audio</button>
                                </div>
                                <div v-if="q.mapData && q.mapData.mapSvg" class="map-container mb-4 p-2 bg-white border" v-html="q.mapData.mapSvg"></div>
                                <p class="mb-2 italic">{{ q.mapData ? q.mapData.mapAsk : 'Listen to the audio...' }}</p>
                            </div>

                            <div v-if="q.skill === 'reading'" class="mb-4 p-3 bg-white border h-64 overflow-y-scroll text-sm leading-relaxed">
                                {{ q.text }}
                            </div>

                            <p class="mb-2">{{ q.text }}</p>

                            <div v-if="q.choices && q.choices.length" class="space-y-1">
                                <label v-for="c in q.choices" :key="c" class="block">
                                    <input type="radio" :name="q.id" :value="c" v-model="answers[q.id]"> {{ c }}
                                </label>
                            </div>
                            <div v-else-if="q.skill === 'writing' || q.skill === 'speaking'">
                                <textarea v-model="answers[q.id]" class="w-full h-32 p-2 border rounded" placeholder="Type answer here..."></textarea>
                            </div>
                            <div v-else>
                                <input type="text" v-model="answers[q.id]" class="w-full p-2 border rounded">
                            </div>
                        </div>
                    </div>

                    <div class="mt-4 pt-4 border-t flex justify-end">
                        <button @click="submitExam" class="bg-green-600 text-white px-6 py-2 rounded font-bold hover:bg-green-700">Submit Exam</button>
                    </div>
                </div>
            </div>

            <div v-else-if="view === 'results'" class="bg-white p-8 rounded shadow">
                <h2 class="text-2xl font-bold mb-6">Results</h2>
                <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
                    <div class="p-4 bg-blue-50 text-center rounded">
                        <div class="text-sm text-gray-500">Reading</div>
                        <div class="text-2xl font-bold">{{ results.scores.reading !== null ? results.scores.reading.toFixed(1) : '‚Äî' }}</div>
                    </div>
                    <div class="p-4 bg-yellow-50 text-center rounded">
                        <div class="text-sm text-gray-500">Listening</div>
                        <div class="text-2xl font-bold">{{ results.scores.listening !== null ? results.scores.listening.toFixed(1) : '‚Äî' }}</div>
                    </div>
                    <div class="p-4 bg-purple-50 text-center rounded">
                        <div class="text-sm text-gray-500">Writing</div>
                        <div class="text-2xl font-bold">{{ results.scores.writing !== null ? results.scores.writing.toFixed(1) : '‚Äî' }}</div>
                    </div>
                    <div class="p-4 bg-pink-50 text-center rounded">
                        <div class="text-sm text-gray-500">Speaking</div>
                        <div class="text-2xl font-bold">{{ results.scores.speaking !== null ? results.scores.speaking.toFixed(1) : '‚Äî' }}</div>
                    </div>
                </div>
                
                <div v-if="results.feedback && results.feedback.feedback" class="mb-6 p-4 bg-gray-50 border rounded">
                    <h3 class="font-bold mb-2">AI Coach Feedback:</h3>
                    <p>{{ results.feedback.feedback }}</p>
                </div>

                <button @click="view = 'dashboard'" class="bg-gray-800 text-white px-4 py-2 rounded">Back to Dashboard</button>
            </div>
            
            <div v-else-if="view === 'history'" class="bg-white p-6 rounded shadow">
                <h2 class="text-xl font-bold mb-4">Attempt History</h2>
                <table class="w-full text-left text-sm">
                    <thead><tr class="border-b"><th>Date</th><th>Mode</th><th>R</th><th>L</th><th>W</th><th>S</th></tr></thead>
                    <tbody>
                        <tr v-for="h in history" :key="h.date" class="border-b">
                            <td class="py-2">{{ new Date(h.date).toLocaleDateString() }}</td>
                            <td>{{ h.mode }} - {{ h.skill || 'All' }}</td>
                            <td>{{ h.R ? Number(h.R).toFixed(1) : '-' }}</td>
                            <td>{{ h.L ? Number(h.L).toFixed(1) : '-' }}</td>
                            <td>{{ h.W ? Number(h.W).toFixed(1) : '-' }}</td>
                            <td>{{ h.S ? Number(h.S).toFixed(1) : '-' }}</td>
                        </tr>
                    </tbody>
                </table>
                <button @click="view = 'dashboard'" class="mt-4 text-blue-600">Back</button>
            </div>

        </main>
    </div>

    <script>
        const { createApp, ref, reactive } = Vue;

        // PASTE YOUR GOOGLE SCRIPT URL HERE
        const API_URL = 'https://script.google.com/macros/s/AKfycbyJwFB2D65RG6KKgu1CBgTgU20atZ4MI2izTNVRLDnv30KsWhiud29eRk-hOnHgTUbCIQ/exec'; 

        createApp({
            setup() {
                const view = ref('dashboard');
                const user = ref(localStorage.getItem('ieltsUser') || null);
                const loading = ref(false);
                const loginForm = reactive({ username: '', password: '' });
                const currentExam = ref(null);
                const answers = ref({});
                const results = ref(null);
                const history = ref([]);
                const timerDisplay = ref("00:00");
                let timerInterval;

                // API HELPER (CORS Workaround)
                const api = async (action, payload = {}) => {
                    loading.value = true;
                    try {
                        const body = new URLSearchParams();
                        body.append('payload', JSON.stringify({ action, username: user.value, ...payload }));
                        
                        const res = await fetch(API_URL, {
                            method: 'POST',
                            body: body
                            // NO HEADERS to avoid CORS Preflight
                        });
                        const data = await res.json();
                        loading.value = false;
                        if (!data.ok) throw new Error(data.error || 'Server error');
                        return data;
                    } catch (e) {
                        loading.value = false;
                        alert("Error: " + e.message);
                        throw e;
                    }
                };

                const doLogin = async () => {
                    if(!loginForm.username) return;
                    try {
                        const res = await api('login', loginForm);
                        user.value = res.username;
                        localStorage.setItem('ieltsUser', res.username);
                        view.value = 'dashboard';
                    } catch(e) {}
                };

                const logout = () => {
                    user.value = null;
                    localStorage.removeItem('ieltsUser');
                    view.value = 'login';
                };

                const startExam = async (mode, skill = null) => {
                    view.value = 'exam';
                    loading.value = true;
                    try {
                        const res = await api('genExam', { mode, skill });
                        currentExam.value = res.exam;
                        answers.value = {};
                        startTimer();
                    } catch (e) {
                        view.value = 'dashboard';
                    }
                };

                const startTimer = () => {
                    let sec = 0;
                    clearInterval(timerInterval);
                    timerInterval = setInterval(() => {
                        sec++;
                        const m = Math.floor(sec/60).toString().padStart(2,'0');
                        const s = (sec%60).toString().padStart(2,'0');
                        timerDisplay.value = `${m}:${s}`;
                    }, 1000);
                };

                const playTTS = (text) => {
                    if(!text) return;
                    const u = new SpeechSynthesisUtterance(text);
                    u.lang = 'en-GB'; // IELTS Accent
                    window.speechSynthesis.speak(u);
                };

                const submitExam = async () => {
                    clearInterval(timerInterval);
                    try {
                        const res = await api('submitAnswers', { 
                            examId: currentExam.value.examId, 
                            answersJson: JSON.stringify(answers.value) 
                        });
                        results.value = res;
                        view.value = 'results';
                    } catch(e) {}
                };

                // Watch for history view to fetch data
                Vue.watch(view, async (newV) => {
                    if(newV === 'history') {
                        const res = await api('getMyHistory');
                        history.value = res.history;
                    }
                });

                if(!user.value) view.value = 'login'; // Init check

                return { 
                    view, user, loading, loginForm, doLogin, logout, 
                    startExam, currentExam, answers, playTTS, submitExam, 
                    results, history, timerDisplay 
                };
            }
        }).mount('#app');
    </script>
</body>
</html>