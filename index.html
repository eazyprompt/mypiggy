<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>IELTS AI (Real) — GitHub Pages + Google Sheets</title>

  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" rel="stylesheet">
  <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

  <style>
    @import url('https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;600;800&display=swap');
    body { font-family: 'Plus Jakarta Sans', sans-serif; }
    .glass { background: rgba(255,255,255,.92); backdrop-filter: blur(10px); }
    .fade-enter-active,.fade-leave-active { transition: opacity .25s; }
    .fade-enter-from,.fade-leave-to { opacity: 0; }
    .slide-up-enter-active { transition: all .25s ease; }
    .slide-up-enter-from { transform: translateY(14px); opacity: 0; }

    .kbd{
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono","Courier New", monospace;
      font-size: 12px;
      border: 1px solid #e2e8f0;
      padding: 2px 6px;
      border-radius: 8px;
      background: #fff;
      color:#0f172a;
    }
    .recording-pulse { animation: pulse-red 1.4s infinite; }
    @keyframes pulse-red{
      0%{ box-shadow:0 0 0 0 rgba(239,68,68,.55); }
      70%{ box-shadow:0 0 0 16px rgba(239,68,68,0); }
      100%{ box-shadow:0 0 0 0 rgba(239,68,68,0); }
    }
  </style>
</head>

<body class="bg-slate-50 text-slate-900 min-h-screen">
<div id="app" class="min-h-screen">

  <!-- LOADING -->
  <transition name="fade">
    <div v-if="loading" class="fixed inset-0 bg-slate-900/70 z-[90] flex items-center justify-center backdrop-blur-sm">
      <div class="bg-white rounded-2xl shadow-2xl w-full max-w-sm mx-4 p-6 text-center">
        <div class="mx-auto mb-4 w-12 h-12 border-4 border-indigo-600 border-t-transparent rounded-full animate-spin"></div>
        <div class="text-lg font-extrabold">{{ loadingMsg }}</div>
        <div class="text-slate-500 text-sm mt-1">Connecting to Google Sheets WebApp…</div>
      </div>
    </div>
  </transition>

  <!-- RESULT MODAL -->
  <transition name="slide-up">
    <div v-if="resultModal.show" class="fixed inset-0 z-[80] bg-black/60 flex items-center justify-center p-4">
      <div class="bg-white rounded-3xl shadow-2xl w-full max-w-4xl overflow-hidden">
        <div class="bg-gradient-to-r from-indigo-600 to-purple-700 px-8 py-6 text-white">
          <div class="flex items-center justify-between">
            <div class="flex items-center gap-3">
              <div class="w-12 h-12 rounded-2xl bg-white/20 flex items-center justify-center text-2xl">
                <i class="fa-solid fa-trophy"></i>
              </div>
              <div>
                <div class="text-2xl font-black">Exam Completed</div>
                <div class="text-indigo-100 text-sm">Saved to Google Sheets + AI feedback (Writing/Speaking)</div>
              </div>
            </div>
            <button @click="resultModal.show=false" class="w-10 h-10 rounded-xl bg-white/15 hover:bg-white/25 transition flex items-center justify-center">
              <i class="fa-solid fa-xmark"></i>
            </button>
          </div>
        </div>

        <div class="p-8 grid grid-cols-1 lg:grid-cols-3 gap-6">
          <div class="lg:col-span-1">
            <div class="rounded-2xl border bg-slate-50 p-5">
              <div class="text-xs font-extrabold text-slate-400 uppercase tracking-wider">Estimated Overall Band</div>
              <div class="mt-2 text-6xl font-black text-indigo-700">{{ resultModal.overall }}</div>
              <div class="mt-3 flex items-center gap-2 text-sm font-bold text-slate-600">
                <i class="fa-solid fa-star text-yellow-400"></i>
                +{{ resultModal.xp }} XP
              </div>
              <div class="mt-4 text-xs text-slate-500 leading-relaxed">
                Reading/Listening are auto-scored. Writing/Speaking are scored by AI via Apps Script.
              </div>
            </div>

            <div class="mt-4 rounded-2xl border p-5">
              <div class="text-xs font-extrabold text-slate-400 uppercase tracking-wider mb-3">Skill Breakdown</div>
              <div v-for="s in ['Reading','Listening','Writing','Speaking']" :key="s" class="mb-3">
                <div class="flex items-center justify-between text-sm font-bold">
                  <span class="text-slate-700">{{ s }}</span>
                  <span class="text-slate-900">{{ resultModal.skills[s] }}</span>
                </div>
                <div class="w-full bg-slate-200 h-2 rounded-full overflow-hidden mt-2">
                  <div class="h-full bg-indigo-600 rounded-full" :style="{width: (resultModal.skills[s]/9)*100 + '%'}"></div>
                </div>
              </div>
            </div>
          </div>

          <div class="lg:col-span-2">
            <div class="rounded-2xl border p-6">
              <div class="flex items-center justify-between">
                <div>
                  <div class="text-xl font-black text-slate-900">Feedback</div>
                  <div class="text-slate-500 text-sm">Summary + next plan</div>
                </div>
                <div class="text-xs font-extrabold text-slate-400 uppercase">Real API</div>
              </div>

              <div class="mt-5 space-y-4">
                <div class="bg-indigo-50 border border-indigo-100 rounded-2xl p-4">
                  <div class="text-xs font-extrabold text-indigo-800 uppercase tracking-wider mb-1">Summary</div>
                  <div class="text-slate-700 text-sm leading-relaxed">{{ resultModal.summary }}</div>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                  <div class="rounded-2xl border p-4">
                    <div class="text-xs font-extrabold text-slate-400 uppercase tracking-wider mb-2">AI Writing (if available)</div>
                    <div v-if="resultModal.ai?.writing?.feedback" class="text-sm text-slate-700 space-y-2">
                      <div><b>Band:</b> {{ resultModal.ai.writing.band }}</div>
                      <div><b>Short summary:</b> {{ resultModal.ai.writing.feedback.short_summary }}</div>
                      <ul class="list-disc pl-5">
                        <li v-for="x in resultModal.ai.writing.feedback.fix_next" :key="x">{{ x }}</li>
                      </ul>
                    </div>
                    <div v-else class="text-sm text-slate-500">No AI writing feedback returned.</div>
                  </div>

                  <div class="rounded-2xl border p-4">
                    <div class="text-xs font-extrabold text-slate-400 uppercase tracking-wider mb-2">AI Speaking (if available)</div>
                    <div v-if="resultModal.ai?.speaking?.feedback" class="text-sm text-slate-700 space-y-2">
                      <div><b>Band:</b> {{ resultModal.ai.speaking.band }}</div>
                      <div><b>Short summary:</b> {{ resultModal.ai.speaking.feedback.short_summary }}</div>
                      <ul class="list-disc pl-5">
                        <li v-for="x in resultModal.ai.speaking.feedback.fix_next" :key="x">{{ x }}</li>
                      </ul>
                    </div>
                    <div v-else class="text-sm text-slate-500">No AI speaking feedback returned.</div>
                  </div>
                </div>

                <div class="rounded-2xl border p-4 bg-slate-50">
                  <div class="text-xs font-extrabold text-slate-400 uppercase tracking-wider mb-2">Next Plan</div>
                  <ul class="text-sm text-slate-700 space-y-1 list-disc pl-5">
                    <li v-for="x in resultModal.next" :key="x">{{ x }}</li>
                  </ul>
                </div>

                <div class="flex gap-3">
                  <button @click="resultModal.show=false; go('dashboard')"
                          class="flex-1 py-3 rounded-2xl bg-slate-900 text-white font-extrabold hover:bg-slate-800 transition">
                    Back to Dashboard
                  </button>
                  <button @click="resultModal.show=false; go('practice')"
                          class="py-3 px-5 rounded-2xl bg-white border font-extrabold text-slate-700 hover:bg-slate-50 transition">
                    Practice More
                  </button>
                </div>
              </div>

            </div>
          </div>
        </div>

      </div>
    </div>
  </transition>

  <!-- LOGIN -->
  <div v-if="view==='login'" class="min-h-screen flex items-center justify-center p-4">
    <div class="w-full max-w-md glass rounded-3xl shadow-2xl border border-white/30 p-8">
      <div class="text-center">
        <div class="inline-flex items-center justify-center w-14 h-14 rounded-2xl bg-indigo-600 text-white text-2xl shadow-lg shadow-indigo-600/30">
          <i class="fa-solid fa-graduation-cap"></i>
        </div>
        <div class="mt-4 text-4xl font-black text-slate-900 tracking-tight">
          IELTS <span class="text-indigo-600">AI</span> (Real)
        </div>
        <div class="text-slate-500 font-semibold">GitHub Pages + Google Sheets WebApp</div>
      </div>

      <div class="mt-6 bg-indigo-50 border border-indigo-100 rounded-2xl p-4 text-sm">
        <div class="text-xs font-extrabold text-indigo-800 uppercase mb-2">Demo Credentials</div>
        <div class="flex justify-between"><span>Student</span><span class="font-bold">student / 123</span></div>
        <div class="flex justify-between"><span>Admin</span><span class="font-bold">admin / 123</span></div>
      </div>

      <div class="mt-6 space-y-3">
        <div>
          <label class="text-xs font-extrabold text-slate-500 uppercase">Username</label>
          <input v-model="auth.u" class="mt-1 w-full p-4 rounded-2xl border focus:ring-2 ring-indigo-500 outline-none font-bold" placeholder="student">
        </div>
        <div>
          <label class="text-xs font-extrabold text-slate-500 uppercase">Password</label>
          <input v-model="auth.p" type="password" class="mt-1 w-full p-4 rounded-2xl border focus:ring-2 ring-indigo-500 outline-none font-bold" placeholder="123">
        </div>
        <button @click="login()" class="w-full py-4 rounded-2xl bg-indigo-600 text-white font-black shadow-lg shadow-indigo-600/30 hover:bg-indigo-700 transition active:scale-[.99]">
          Sign in
        </button>
      </div>

      <div class="mt-5 text-xs text-center text-slate-500">
        Tip: อย่าเปิดผ่าน <code>file:///</code> ให้เปิดผ่าน GitHub Pages หรือ <code>http://localhost</code>
      </div>

      <div class="mt-5 text-xs text-center text-slate-400">
        API_BASE: <span class="font-mono">{{ API_BASE }}</span>
      </div>
    </div>
  </div>

  <!-- APP -->
  <div v-else class="min-h-screen">
    <!-- Top Bar -->
    <div class="h-16 bg-white border-b flex items-center justify-between px-4 md:px-8">
      <div class="flex items-center gap-3">
        <div class="w-11 h-11 rounded-2xl bg-gradient-to-br from-indigo-500 to-purple-600 flex items-center justify-center text-white font-black shadow-lg">
          {{ (me.username||'U').charAt(0).toUpperCase() }}
        </div>
        <div>
          <div class="font-black text-slate-900 leading-tight">IELTS AI (Real)</div>
          <div class="text-xs text-slate-500 font-extrabold uppercase tracking-wider">{{ me.username }} • {{ me.role }}</div>
        </div>
      </div>

      <div class="flex items-center gap-2">
        <div class="px-4 py-2 rounded-full border bg-white text-sm font-extrabold">
          <i class="fa-solid fa-star text-yellow-400"></i> {{ me.xp || 0 }} XP
        </div>
        <button @click="logout()" class="px-4 py-2 rounded-2xl bg-slate-900 text-white font-extrabold hover:bg-slate-800">
          <i class="fa-solid fa-right-from-bracket"></i> Logout
        </button>
      </div>
    </div>

    <!-- Content -->
    <div class="max-w-6xl mx-auto p-4 md:p-8">

      <!-- NAV -->
      <div class="flex flex-wrap gap-2 mb-6">
        <button @click="go('dashboard')" class="px-4 py-2 rounded-2xl border font-extrabold"
          :class="view==='dashboard' ? 'bg-indigo-600 text-white border-indigo-600' : 'bg-white'">
          Dashboard
        </button>
        <button @click="go('practice')" class="px-4 py-2 rounded-2xl border font-extrabold"
          :class="view==='practice' ? 'bg-indigo-600 text-white border-indigo-600' : 'bg-white'">
          Practice
        </button>
        <button @click="go('history')" class="px-4 py-2 rounded-2xl border font-extrabold"
          :class="view==='history' ? 'bg-indigo-600 text-white border-indigo-600' : 'bg-white'">
          History
        </button>
        <button v-if="me.role==='admin'" @click="go('admin')" class="px-4 py-2 rounded-2xl border font-extrabold"
          :class="view==='admin' ? 'bg-indigo-600 text-white border-indigo-600' : 'bg-white'">
          Admin
        </button>
      </div>

      <!-- DASHBOARD -->
      <section v-if="view==='dashboard'">
        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
          <div class="rounded-2xl border bg-white p-5">
            <div class="text-xs font-extrabold text-slate-400 uppercase">Full Mock quota</div>
            <div class="mt-2 text-xl font-black">
              {{ me.quota?.fullUsed ?? 0 }} / {{ me.quota?.fullLimit ?? 2 }}
            </div>
          </div>
          <div class="rounded-2xl border bg-white p-5">
            <div class="text-xs font-extrabold text-slate-400 uppercase">Skill quota (per skill)</div>
            <div class="mt-2 text-sm font-black leading-6">
              R {{ me.quota?.skill?.reading?.used ?? 0 }}/{{ me.quota?.skill?.reading?.limit ?? 15 }},
              L {{ me.quota?.skill?.listening?.used ?? 0 }}/{{ me.quota?.skill?.listening?.limit ?? 15 }},
              W {{ me.quota?.skill?.writing?.used ?? 0 }}/{{ me.quota?.skill?.writing?.limit ?? 15 }},
              S {{ me.quota?.skill?.speaking?.used ?? 0 }}/{{ me.quota?.skill?.speaking?.limit ?? 15 }}
            </div>
          </div>
          <div class="rounded-2xl border bg-white p-5">
            <div class="text-xs font-extrabold text-slate-400 uppercase">Weekly Key</div>
            <div class="mt-2 text-xl font-black text-indigo-700">{{ me.quota?.weekKey || '—' }}</div>
          </div>
        </div>

        <div class="mt-6 rounded-3xl bg-gradient-to-r from-indigo-600 to-purple-700 p-7 md:p-8 text-white shadow-xl">
          <div class="inline-flex items-center gap-2 px-3 py-1 rounded-xl bg-white/15 border border-white/25 text-xs font-extrabold uppercase tracking-wider">
            <i class="fa-solid fa-layer-group"></i> Full Mock Exam (Real Count)
          </div>
          <div class="mt-3 text-3xl md:text-4xl font-black">Listening 40 • Reading 40 • Writing 2 • Speaking 3</div>
          <div class="mt-2 text-indigo-100 text-sm leading-relaxed">
            Your attempt will be saved to Google Sheets. Writing/Speaking scored by AI.
          </div>
          <div class="mt-5 flex flex-wrap gap-3">
            <button @click="startFullMock()"
                    class="px-6 py-3 rounded-2xl bg-white text-indigo-700 font-black hover:bg-indigo-50 transition">
              Start Full Mock
            </button>
            <button @click="fetchAnalytics()"
                    class="px-6 py-3 rounded-2xl bg-white/15 border border-white/25 font-black hover:bg-white/20 transition">
              Refresh Analytics
            </button>
          </div>
        </div>

        <div class="mt-6 grid grid-cols-1 lg:grid-cols-2 gap-4">
          <div class="rounded-2xl border bg-white p-5">
            <div class="flex items-center justify-between">
              <div>
                <div class="font-black text-slate-900">My Trend (last 30 days)</div>
                <div class="text-slate-500 text-sm">Overall + skill lines</div>
              </div>
            </div>
            <div class="mt-4"><canvas id="myLine" height="260"></canvas></div>
          </div>

          <div class="rounded-2xl border bg-white p-5">
            <div class="font-black text-slate-900">Skill Average</div>
            <div class="text-slate-500 text-sm">Radar</div>
            <div class="mt-4"><canvas id="myRadar" height="260"></canvas></div>
          </div>
        </div>
      </section>

      <!-- PRACTICE -->
      <section v-if="view==='practice'">
        <div class="rounded-2xl border bg-white p-6">
          <div class="text-2xl font-black">Skill Practice (Direct)</div>
          <div class="text-slate-500 font-semibold mt-1">Listening 10 • Reading mixed • Writing (T1+T2) • Speaking (1)</div>

          <div class="mt-4 grid grid-cols-1 md:grid-cols-4 gap-3">
            <button @click="startSkill('reading')" class="rounded-2xl border p-4 hover:bg-slate-50 transition text-left">
              <div class="text-indigo-600 text-xl"><i class="fa-solid fa-book-open"></i></div>
              <div class="mt-2 font-black">Reading</div>
              <div class="text-xs text-slate-500">Long passage + TFNG + MCQ + One-word</div>
            </button>
            <button @click="startSkill('listening')" class="rounded-2xl border p-4 hover:bg-slate-50 transition text-left">
              <div class="text-indigo-600 text-xl"><i class="fa-solid fa-headphones"></i></div>
              <div class="mt-2 font-black">Listening</div>
              <div class="text-xs text-slate-500">10 questions (includes map)</div>
            </button>
            <button @click="startSkill('writing')" class="rounded-2xl border p-4 hover:bg-slate-50 transition text-left">
              <div class="text-indigo-600 text-xl"><i class="fa-solid fa-pen"></i></div>
              <div class="mt-2 font-black">Writing</div>
              <div class="text-xs text-slate-500">Task 1 + Task 2</div>
            </button>
            <button @click="startSkill('speaking')" class="rounded-2xl border p-4 hover:bg-slate-50 transition text-left">
              <div class="text-indigo-600 text-xl"><i class="fa-solid fa-microphone"></i></div>
              <div class="mt-2 font-black">Speaking</div>
              <div class="text-xs text-slate-500">1 prompt (type transcript)</div>
            </button>
          </div>
        </div>
      </section>

      <!-- EXAM -->
      <section v-if="view==='exam'" class="rounded-2xl border bg-white overflow-hidden">
        <div class="h-16 border-b px-4 md:px-6 flex items-center justify-between bg-white">
          <div class="flex items-center gap-3">
            <span class="px-3 py-1 rounded-xl text-xs font-extrabold uppercase tracking-wider bg-slate-100 text-slate-700">
              {{ exam.section }}
            </span>
            <div class="font-black text-slate-900">{{ exam.title }}</div>
          </div>
          <div class="flex items-center gap-3">
            <div class="hidden md:block text-xs font-extrabold text-slate-500">
              Step {{ exam.index+1 }}/{{ exam.steps.length }}
            </div>
            <div class="font-mono text-sm font-extrabold text-slate-500">{{ timerText }}</div>
            <button @click="confirmExit()" class="w-10 h-10 rounded-xl border hover:bg-slate-50 transition" title="Exit">
              <i class="fa-solid fa-door-open"></i>
            </button>
          </div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-2">
          <div class="border-r bg-slate-50 p-5 md:p-8 overflow-y-auto max-h-[72vh]">
            <div class="text-xl font-black text-slate-900">{{ currentStep.title }}</div>
            <div class="mt-3 rounded-2xl border bg-white p-5">
              <div class="text-xs font-extrabold text-slate-400 uppercase tracking-wider mb-3">Passage / Prompt</div>

              <div v-if="currentStep.section==='Writing'" class="text-sm text-slate-700 whitespace-pre-wrap">{{ currentStep.prompt }}</div>
              <div v-else-if="currentStep.section==='Speaking'" class="text-sm text-slate-700 whitespace-pre-wrap">{{ currentStep.prompt }}</div>
              <div v-else class="text-sm text-slate-700 whitespace-pre-wrap">{{ currentStep.passage }}</div>

              <div v-if="currentStep.mapImg" class="mt-4">
                <div class="text-xs font-extrabold text-slate-400 uppercase tracking-wider mb-2">Map</div>
                <img :src="currentStep.mapImg" class="w-full rounded-2xl border" alt="map">
              </div>

              <div v-if="currentStep.chartImg" class="mt-4">
                <div class="text-xs font-extrabold text-slate-400 uppercase tracking-wider mb-2">Chart</div>
                <img :src="currentStep.chartImg" class="w-full rounded-2xl border" alt="chart">
              </div>
            </div>
          </div>

          <div class="p-5 md:p-8 overflow-y-auto max-h-[72vh]">
            <div class="flex items-start justify-between gap-3">
              <div>
                <div class="text-lg font-black text-slate-900">Question</div>
                <div class="text-slate-600 text-sm font-semibold">{{ currentStep.qText || 'Write / Speak response below' }}</div>
              </div>
              <div class="text-xs font-extrabold text-slate-400 uppercase">{{ currentStep.points || 1 }} pts</div>
            </div>

            <!-- MCQ / TFNG -->
            <div v-if="currentStep.qType==='mcq' || currentStep.qType==='tfng'" class="mt-6 space-y-3">
              <div v-for="c in currentStep.choices" :key="c"
                @click="setAnswer(c)"
                class="p-4 rounded-2xl border cursor-pointer transition font-semibold"
                :class="answerOf(currentStep.id)===c ? 'border-indigo-600 bg-indigo-50 ring-1 ring-indigo-600' : 'border-slate-200 hover:border-slate-300 hover:bg-slate-50'">
                {{ c }}
              </div>
            </div>

            <!-- SHORT -->
            <div v-else-if="currentStep.qType==='short'" class="mt-6">
              <label class="text-xs font-extrabold text-slate-500 uppercase">Answer</label>
              <input class="mt-2 w-full p-4 rounded-2xl border bg-slate-50 focus:ring-2 ring-indigo-500 outline-none"
                     :value="answerOf(currentStep.id)||''"
                     @input="setAnswer($event.target.value)"
                     placeholder="Type ONE word / number">
            </div>

            <!-- WRITING -->
            <div v-else-if="currentStep.section==='Writing'" class="mt-6">
              <div class="flex items-center justify-between text-xs font-extrabold text-slate-500 uppercase">
                <span>Essay</span>
                <span>{{ wordCount(answerOf(currentStep.id)||'') }} words</span>
              </div>
              <textarea class="mt-2 w-full h-72 md:h-96 p-4 rounded-2xl border bg-slate-50 focus:ring-2 ring-indigo-500 outline-none resize-none"
                        :value="answerOf(currentStep.id)||''"
                        @input="setAnswer($event.target.value)"
                        placeholder="Type your answer here..."></textarea>
              <div class="mt-3 text-xs text-slate-500">
                Task 1 >= 150 words, Task 2 >= 250 words (ตรวจแบบเบา ๆ ที่ client)
              </div>
            </div>

            <!-- SPEAKING (transcript input) -->
            <div v-else-if="currentStep.section==='Speaking'" class="mt-6">
              <div class="rounded-2xl border bg-slate-50 p-4">
                <div class="text-xs font-extrabold text-slate-500 uppercase mb-2">Transcript (type what you said)</div>
                <textarea class="w-full h-48 p-4 rounded-2xl border bg-white focus:ring-2 ring-indigo-500 outline-none resize-none"
                          :value="answerOf(currentStep.id)||''"
                          @input="setAnswer($event.target.value)"
                          placeholder="Paste / type your speaking transcript here..."></textarea>
                <div class="mt-2 text-xs text-slate-500">
                  (ทำเป็นพิมพ์ transcript เพื่อให้ AI ให้คะแนนได้เสถียรบนทุก browser)
                </div>
              </div>
            </div>

            <div class="mt-7 grid grid-cols-1 md:grid-cols-3 gap-3">
              <button @click="prevStep()"
                      class="py-3 rounded-2xl border font-extrabold text-slate-700 hover:bg-slate-50 transition"
                      :disabled="exam.index===0"
                      :class="exam.index===0 ? 'opacity-50 cursor-not-allowed' : ''">
                <i class="fa-solid fa-arrow-left"></i> Previous
              </button>

              <button @click="saveProgress()"
                      class="py-3 rounded-2xl border font-extrabold text-slate-700 hover:bg-slate-50 transition">
                <i class="fa-solid fa-floppy-disk"></i> Save (local)
              </button>

              <button @click="nextOrFinish()"
                      class="py-3 rounded-2xl bg-slate-900 text-white font-black hover:bg-slate-800 transition">
                {{ exam.index === exam.steps.length-1 ? 'Finish & Submit' : 'Submit & Next' }}
                <i class="fa-solid fa-arrow-right ml-2"></i>
              </button>
            </div>

            <div class="mt-4 text-xs text-slate-500">
              Keyboard: <span class="kbd">N</span> next, <span class="kbd">P</span> prev, <span class="kbd">ESC</span> exit
            </div>
          </div>
        </div>
      </section>

      <!-- HISTORY -->
      <section v-if="view==='history'" class="rounded-2xl border bg-white p-6">
        <div class="flex items-end justify-between gap-3">
          <div>
            <div class="text-2xl font-black">History</div>
            <div class="text-slate-500 font-semibold">Loaded from Google Sheets</div>
          </div>
          <button @click="loadHistory()" class="px-4 py-2 rounded-2xl border font-extrabold hover:bg-slate-50">Refresh</button>
        </div>

        <div class="mt-6 space-y-3">
          <div v-if="history.length===0" class="rounded-2xl border bg-slate-50 p-6 text-slate-500 font-semibold">
            No attempts yet.
          </div>

          <div v-for="h in history" :key="h.attemptId"
               class="rounded-2xl border bg-white p-5 flex flex-col md:flex-row md:items-center md:justify-between gap-3">
            <div>
              <div class="font-black text-slate-900">
                {{ h.mode.toUpperCase() }} <span v-if="h.skill">• {{ h.skill }}</span>
                <span v-if="h.overall">• Overall {{ h.overall }}</span>
              </div>
              <div class="text-sm text-slate-500">
                {{ h.submittedAt || h.startedAt }}
              </div>
              <div v-if="h.overall" class="text-sm text-slate-600 mt-1">
                R {{ h.reading }} / L {{ h.listening }} / W {{ h.writing }} / S {{ h.speaking }}
              </div>
            </div>
            <div class="text-sm font-extrabold text-slate-600">
              +{{ h.xp }} XP
            </div>
          </div>
        </div>
      </section>

      <!-- ADMIN -->
      <section v-if="view==='admin' && me.role==='admin'" class="space-y-4">
        <div class="rounded-2xl border bg-white p-6">
          <div class="flex items-end justify-between gap-3">
            <div>
              <div class="text-2xl font-black">Admin — Users</div>
              <div class="text-slate-500 font-semibold">Manage users + quotas</div>
            </div>
            <button @click="adminOpenAdd=true" class="px-4 py-2 rounded-2xl bg-emerald-600 text-white font-extrabold">
              <i class="fa-solid fa-plus"></i> Add user
            </button>
          </div>

          <div class="mt-4 overflow-x-auto">
            <table class="w-full text-left">
              <thead class="bg-slate-50 text-slate-500 text-xs font-extrabold uppercase">
                <tr>
                  <th class="p-3">User</th>
                  <th class="p-3">Role</th>
                  <th class="p-3">Quota (full)</th>
                  <th class="p-3">Quota (skills)</th>
                  <th class="p-3">XP</th>
                  <th class="p-3 text-right">Actions</th>
                </tr>
              </thead>
              <tbody class="divide-y">
                <tr v-for="u in adminUsers" :key="u.username" class="hover:bg-slate-50">
                  <td class="p-3 font-black">{{ u.username }}</td>
                  <td class="p-3"><span class="px-2 py-1 rounded-lg text-xs font-extrabold"
                    :class="u.role==='admin'?'bg-purple-100 text-purple-700':'bg-blue-100 text-blue-700'">{{ u.role }}</span></td>
                  <td class="p-3 text-sm font-bold">{{ u.quota.fullUsed }}/{{ u.quota.fullLimit }}</td>
                  <td class="p-3 text-xs">
                    R {{u.quota.skill.reading.used}}/{{u.quota.skill.reading.limit}},
                    L {{u.quota.skill.listening.used}}/{{u.quota.skill.listening.limit}},
                    W {{u.quota.skill.writing.used}}/{{u.quota.skill.writing.limit}},
                    S {{u.quota.skill.speaking.used}}/{{u.quota.skill.speaking.limit}}
                  </td>
                  <td class="p-3 font-extrabold">{{ u.xp }}</td>
                  <td class="p-3 text-right space-x-2">
                    <button @click="adminReset(u.username)"
                            class="px-3 py-2 rounded-xl text-xs font-extrabold bg-slate-100 hover:bg-slate-200">
                      Reset quota
                    </button>
                    <button v-if="u.username!=='admin'" @click="adminDelete(u.username)"
                            class="px-3 py-2 rounded-xl text-xs font-extrabold bg-red-50 hover:bg-red-100 text-red-600">
                      Delete
                    </button>
                  </td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>

        <div class="rounded-2xl border bg-white p-6">
          <div class="flex flex-col md:flex-row md:items-end md:justify-between gap-4">
            <div>
              <div class="text-2xl font-black">Admin — Analytics</div>
              <div class="text-slate-500 font-semibold">Avg + trend across users</div>
            </div>
            <div class="flex gap-2">
              <select v-model="adminSelUser" class="px-4 py-2 rounded-2xl border font-bold">
                <option value="">All users</option>
                <option v-for="u in adminUsers.filter(x=>x.role!=='admin')" :key="u.username" :value="u.username">{{u.username}}</option>
              </select>
              <select v-model="adminDays" class="px-4 py-2 rounded-2xl border font-bold">
                <option :value="7">Last 7 days</option>
                <option :value="30">Last 30 days</option>
                <option :value="90">Last 90 days</option>
                <option :value="365">Last 12 months</option>
              </select>
              <button @click="adminLoadAnalytics()" class="px-4 py-2 rounded-2xl bg-slate-900 text-white font-extrabold">
                Refresh
              </button>
            </div>
          </div>

          <div class="mt-4 grid grid-cols-1 lg:grid-cols-2 gap-4">
            <div class="rounded-2xl border p-4">
              <div class="font-black">Admin Trend</div>
              <div class="mt-3"><canvas id="adminLine" height="240"></canvas></div>
            </div>
            <div class="rounded-2xl border p-4">
              <div class="font-black">Admin Radar (avg)</div>
              <div class="mt-3"><canvas id="adminRadar" height="240"></canvas></div>
            </div>
          </div>

        </div>

        <!-- Add user modal -->
        <transition name="slide-up">
          <div v-if="adminOpenAdd" class="fixed inset-0 z-[85] bg-black/60 flex items-center justify-center p-4">
            <div class="bg-white rounded-3xl shadow-2xl w-full max-w-md p-6">
              <div class="flex items-center justify-between">
                <div class="text-xl font-black">Create New User</div>
                <button @click="adminOpenAdd=false" class="w-10 h-10 rounded-xl border hover:bg-slate-50 transition">
                  <i class="fa-solid fa-xmark"></i>
                </button>
              </div>

              <div class="mt-4 space-y-3">
                <input v-model="adminNew.u" class="w-full p-4 rounded-2xl border" placeholder="username">
                <input v-model="adminNew.p" class="w-full p-4 rounded-2xl border" placeholder="password">
                <select v-model="adminNew.role" class="w-full p-4 rounded-2xl border bg-white font-semibold">
                  <option value="student">student</option>
                  <option value="admin">admin</option>
                </select>

                <div class="grid grid-cols-2 gap-3 mt-2">
                  <button @click="adminOpenAdd=false" class="py-3 rounded-2xl border font-extrabold">Cancel</button>
                  <button @click="adminAdd()" class="py-3 rounded-2xl bg-indigo-600 text-white font-black">Create</button>
                </div>
              </div>

              <div class="mt-4 text-xs text-slate-500">
                Users are stored in Google Sheets (Users sheet).
              </div>
            </div>
          </div>
        </transition>

      </section>

    </div>
  </div>
</div>

<script>
const { createApp } = Vue;

/** IMPORTANT:
 *  Put your Apps Script Web App URL here (ends with /exec)
 *  Example: https://script.google.com/macros/s/AKfycbx.../exec
 */
const API_BASE = "https://script.google.com/macros/s/AKfycbxFj3jOCSw0SKhQ7_oHsuDlcIsLf2yRbAaOo1e43a1XtyYOkxlfGtjQNe5Vq_XLy-m0/exec";

/** CORS FIX:
 *  Send body as plain string, DO NOT set Content-Type header
 *  -> avoids preflight (OPTIONS)
 */
async function apiPost(op, data = {}) {
  const body = JSON.stringify({ op, ...data });
  const res = await fetch(API_BASE, { method: "POST", body, redirect: "follow" });
  const text = await res.text();
  try { return JSON.parse(text); }
  catch { throw new Error("API non-JSON: " + text); }
}

createApp({
  data(){
    return {
      API_BASE,
      view:'login',
      loading:false,
      loadingMsg:'',
      auth:{ u:'', p:'' },

      token: localStorage.getItem('IELTS_TOKEN') || '',
      me: {},

      // exam state
      attemptId: '',
      exam:{ title:'', steps:[], index:0, section:'' },
      answers:{}, // stepId -> answer
      timer:{ leftSec:0, t:null },

      // charts
      charts:{ myLine:null, myRadar:null, adminLine:null, adminRadar:null },

      // history
      history:[],

      // admin
      adminUsers:[],
      adminOpenAdd:false,
      adminNew:{ u:'', p:'', role:'student' },
      adminSelUser:'',
      adminDays:30,
      adminAnalytics:null,

      // result
      resultModal:{ show:false, overall:'0.0', skills:{}, summary:'', next:[], xp:0, ai:null }
    }
  },

  computed:{
    currentStep(){
      return this.exam.steps[this.exam.index] || {};
    },
    timerText(){
      const s = this.timer.leftSec || 0;
      const hh = String(Math.floor(s/3600)).padStart(2,'0');
      const mm = String(Math.floor((s%3600)/60)).padStart(2,'0');
      const ss = String(s%60).padStart(2,'0');
      return `${hh}:${mm}:${ss}`;
    }
  },

  mounted(){
    window.addEventListener('keydown', this.onKey);
    if(this.token){
      this.bootstrap();
    }
  },
  beforeUnmount(){
    window.removeEventListener('keydown', this.onKey);
    this.stopTimer();
  },

  methods:{
    onKey(e){
      if(this.view !== 'exam') return;
      if(e.key.toLowerCase()==='n') this.nextOrFinish();
      if(e.key.toLowerCase()==='p') this.prevStep();
      if(e.key==='Escape') this.confirmExit();
    },

    async bootstrap(){
      try{
        this.loading=true; this.loadingMsg='Loading profile…';
        const r = await apiPost('me', { token: this.token });
        this.loading=false;
        if(!r.ok) throw new Error(r.error||'auth failed');
        this.me = r.user;
        this.view = (this.me.role==='admin') ? 'admin' : 'dashboard';
        if(this.view==='dashboard') await this.fetchAnalytics();
        if(this.me.role==='admin'){
          await this.adminLoadUsers();
          await this.adminLoadAnalytics();
        }
      }catch(err){
        this.loading=false;
        console.warn(err);
        this.token='';
        localStorage.removeItem('IELTS_TOKEN');
        this.view='login';
      }
    },

    go(v){
      this.view=v;
      if(v==='dashboard') this.fetchAnalytics();
      if(v==='history') this.loadHistory();
      if(v==='admin' && this.me.role==='admin'){
        this.adminLoadUsers();
        this.adminLoadAnalytics();
      }
    },

    async login(){
      try{
        this.loading=true; this.loadingMsg='Authenticating…';
        const r = await apiPost('login', { u:this.auth.u, p:this.auth.p });
        this.loading=false;
        if(!r.ok) return alert(r.error || 'Login failed');
        this.token = r.token;
        localStorage.setItem('IELTS_TOKEN', this.token);
        this.me = r.user;
        this.view = (this.me.role==='admin') ? 'admin' : 'dashboard';
        if(this.view==='dashboard') await this.fetchAnalytics();
        if(this.me.role==='admin'){
          await this.adminLoadUsers();
          await this.adminLoadAnalytics();
        }
      }catch(err){
        this.loading=false;
        alert(String(err));
      }
    },

    logout(){
      this.stopTimer();
      this.token='';
      localStorage.removeItem('IELTS_TOKEN');
      this.me={};
      this.view='login';
      this.answers={};
      this.exam={ title:'', steps:[], index:0, section:'' };
      this.history=[];
    },

    // ---------- Exam start ----------
    async startFullMock(){
      await this.startExam({ mode:'full', skill:'' });
    },
    async startSkill(skill){
      await this.startExam({ mode:'skill', skill });
    },
    async startExam({mode, skill}){
      try{
        this.loading=true; this.loadingMsg='Generating exam…';
        const r = await apiPost('genExam', { token:this.token, mode, skill });
        this.loading=false;
        if(!r.ok) return alert(r.error || 'Cannot start');

        this.me = r.user; // updated quota
        this.attemptId = r.attemptId;

        this.exam.title = r.exam.title;
        this.exam.steps = r.exam.steps;
        this.exam.index = 0;
        this.exam.section = this.exam.steps[0]?.section || '';

        this.answers = {};
        this.timer.leftSec = r.exam.timerSec || 3600;
        this.stopTimer();
        this.timer.t = setInterval(()=>{
          this.timer.leftSec--;
          if(this.timer.leftSec<=0){
            this.timer.leftSec=0;
            this.stopTimer();
            this.finishSubmit();
          }
        },1000);

        this.view='exam';
      }catch(err){
        this.loading=false;
        alert(String(err));
      }
    },

    stopTimer(){
      if(this.timer.t){ clearInterval(this.timer.t); this.timer.t=null; }
    },

    confirmExit(){
      if(confirm('Exit exam? Your progress is kept locally only (Save).')){
        this.stopTimer();
        this.go('dashboard');
      }
    },

    // ---------- Answers ----------
    setAnswer(val){
      const id = this.currentStep.id;
      this.answers[id] = val;
    },
    answerOf(id){
      return this.answers[id] ?? '';
    },
    wordCount(text){
      if(!text) return 0;
      return String(text).trim().split(/\s+/).filter(Boolean).length;
    },

    saveProgress(){
      const key = 'IELTS_LOCAL_SAVE_' + (this.attemptId||'');
      localStorage.setItem(key, JSON.stringify({ attemptId:this.attemptId, answers:this.answers, idx:this.exam.index }));
      alert('Saved locally.');
    },

    prevStep(){
      if(this.exam.index===0) return;
      this.exam.index--;
      this.exam.section = this.currentStep.section || '';
    },

    nextOrFinish(){
      // Light client validation
      const step = this.currentStep;

      if(step.section==='Writing'){
        const wc = this.wordCount(this.answerOf(step.id));
        if(step.title.includes('Task 1') && wc < 120){
          if(!confirm('Task 1 seems short. Submit anyway?')) return;
        }
        if(step.title.includes('Task 2') && wc < 180){
          if(!confirm('Task 2 seems short. Submit anyway?')) return;
        }
      }else{
        if((step.qType==='mcq' || step.qType==='tfng') && !this.answerOf(step.id)){
          return alert('Please select an answer.');
        }
      }

      if(this.exam.index < this.exam.steps.length-1){
        this.exam.index++;
        this.exam.section = this.currentStep.section || '';
      }else{
        this.finishSubmit();
      }
    },

    async finishSubmit(){
      try{
        this.stopTimer();
        this.loading=true; this.loadingMsg='Submitting + scoring (AI)…';
        const r = await apiPost('submitAttempt', { token:this.token, attemptId:this.attemptId, answers:this.answers });
        this.loading=false;
        if(!r.ok) return alert(r.error || 'Submit failed');

        this.me = r.user;

        const result = r.result;
        this.resultModal = {
          show:true,
          overall: Number(result.overall).toFixed(1),
          skills: result.skills,
          summary: result.summary,
          next: result.next,
          xp: result.xp,
          ai: result.ai
        };

        // back to dashboard after closing modal
        this.view='dashboard';
        await this.fetchAnalytics();
      }catch(err){
        this.loading=false;
        alert(String(err));
      }
    },

    // ---------- Analytics ----------
    async fetchAnalytics(){
      try{
        const r = await apiPost('getAnalytics', { token:this.token, days:30 });
        if(!r.ok) return;

        // charts
        this.$nextTick(()=>{
          const labels = r.trend.map(x => (new Date(x.t)).toLocaleDateString());
          const series = (k)=> r.trend.map(x => x[k] || 0);

          if(this.charts.myLine){ this.charts.myLine.destroy(); this.charts.myLine=null; }
          if(this.charts.myRadar){ this.charts.myRadar.destroy(); this.charts.myRadar=null; }

          const lineEl = document.getElementById('myLine');
          if(lineEl){
            this.charts.myLine = new Chart(lineEl, {
              type:'line',
              data:{
                labels,
                datasets:[
                  { label:'Overall', data: series('Overall'), tension:.25 },
                  { label:'Reading', data: series('Reading'), tension:.25 },
                  { label:'Listening', data: series('Listening'), tension:.25 },
                  { label:'Writing', data: series('Writing'), tension:.25 },
                  { label:'Speaking', data: series('Speaking'), tension:.25 }
                ]
              },
              options:{ plugins:{ legend:{ position:'bottom' } }, scales:{ y:{ suggestedMin:0, suggestedMax:9 } } }
            });
          }

          const radarEl = document.getElementById('myRadar');
          if(radarEl){
            this.charts.myRadar = new Chart(radarEl, {
              type:'radar',
              data:{
                labels:['Reading','Listening','Writing','Speaking'],
                datasets:[{ label:'Avg', data:[r.avg.Reading,r.avg.Listening,r.avg.Writing,r.avg.Speaking], fill:true }]
              },
              options:{ plugins:{ legend:{ display:false } }, scales:{ r:{ suggestedMin:0, suggestedMax:9 } } }
            });
          }
        });
      }catch(e){
        console.warn(e);
      }
    },

    // ---------- History ----------
    async loadHistory(){
      try{
        const r = await apiPost('getHistory', { token:this.token, limit:50 });
        if(!r.ok) return alert(r.error||'History failed');
        this.history = r.items || [];
      }catch(err){
        alert(String(err));
      }
    },

    // ---------- Admin ----------
    async adminLoadUsers(){
      const r = await apiPost('adminListUsers', { token:this.token });
      if(r.ok) this.adminUsers = r.users || [];
    },
    async adminAdd(){
      if(!this.adminNew.u || !this.adminNew.p) return alert('Fill username + password');
      const r = await apiPost('adminAddUser', { token:this.token, username:this.adminNew.u, password:this.adminNew.p, role:this.adminNew.role });
      if(!r.ok) return alert(r.error||'Add failed');
      this.adminUsers = r.users || [];
      this.adminOpenAdd=false;
      this.adminNew={ u:'', p:'', role:'student' };
    },
    async adminDelete(username){
      if(!confirm(`Delete ${username}?`)) return;
      const r = await apiPost('adminDeleteUser', { token:this.token, username });
      if(!r.ok) return alert(r.error||'Delete failed');
      this.adminUsers = r.users || [];
    },
    async adminReset(username){
      const r = await apiPost('adminResetQuota', { token:this.token, username });
      if(!r.ok) return alert(r.error||'Reset failed');
      this.adminUsers = r.users || [];
    },
    async adminLoadAnalytics(){
      const r = await apiPost('adminAnalytics', { token:this.token, selectedUser:this.adminSelUser, days:this.adminDays });
      if(!r.ok) return;

      this.adminAnalytics = r;

      this.$nextTick(()=>{
        const labels = r.trend.map(x => (new Date(x.t)).toLocaleDateString());
        const series = (k)=> r.trend.map(x => x[k] || 0);

        if(this.charts.adminLine){ this.charts.adminLine.destroy(); this.charts.adminLine=null; }
        if(this.charts.adminRadar){ this.charts.adminRadar.destroy(); this.charts.adminRadar=null; }

        const lineEl = document.getElementById('adminLine');
        if(lineEl){
          this.charts.adminLine = new Chart(lineEl, {
            type:'line',
            data:{
              labels,
              datasets:[
                { label:'Overall', data: series('Overall'), tension:.25 },
                { label:'Reading', data: series('Reading'), tension:.25 },
                { label:'Listening', data: series('Listening'), tension:.25 },
                { label:'Writing', data: series('Writing'), tension:.25 },
                { label:'Speaking', data: series('Speaking'), tension:.25 }
              ]
            },
            options:{ plugins:{ legend:{ position:'bottom' } }, scales:{ y:{ suggestedMin:0, suggestedMax:9 } } }
          });
        }

        const radarEl = document.getElementById('adminRadar');
        if(radarEl){
          this.charts.adminRadar = new Chart(radarEl, {
            type:'radar',
            data:{
              labels:['Reading','Listening','Writing','Speaking'],
              datasets:[{ label:'Avg', data:[r.avg.Reading,r.avg.Listening,r.avg.Writing,r.avg.Speaking], fill:true }]
            },
            options:{ plugins:{ legend:{ display:false } }, scales:{ r:{ suggestedMin:0, suggestedMax:9 } } }
          });
        }
      });
    }
  }
}).mount('#app');
</script>
</body>
</html>
