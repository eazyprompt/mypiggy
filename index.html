<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8" />

  <link rel="icon" type="image/png" sizes="32x32" href="favicon-32.png">
  <link rel="icon" type="image/png" sizes="16x16" href="favicon-16.png">
  <link rel="apple-touch-icon" sizes="180x180" href="apple-touch-icon.png">
  <link rel="manifest" href="manifest.webmanifest">
  <meta name="theme-color" content="#020617">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="My Piggy">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover, user-scalable=no" />

  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

  <style>
    :root{
  --primary: #3b82f6;
  --primary-2: #06b6d4;
  --primary-soft: rgba(59, 130, 246, 0.22);

  --success: #34d399;
  --danger: #fb7185;

  --text-main: rgba(226, 232, 240, 0.98);
  --text-muted: rgba(148, 163, 184, 0.95);
  --text-faint: rgba(148, 163, 184, 0.72);

  --bg-body: #020617;
  --surface: rgba(255,255,255,0.06);
  --surface-2: rgba(255,255,255,0.10);

  --border: rgba(148, 163, 184, 0.16);
  --shadow: 0 22px 60px rgba(0, 0, 0, 0.55);
  --shadow-soft: 0 14px 36px rgba(0, 0, 0, 0.40);

  --ring: 0 0 0 4px rgba(6, 182, 212, 0.22);

  --radius-xl: 2rem;
  --radius-lg: 1.5rem;
  --radius-md: 1rem;
}


    * { -webkit-tap-highlight-color: transparent; }

    body {
  font-family: 'Kanit', sans-serif;
  color: var(--text-main);
  background-color: var(--bg-body);
  background-image:
    radial-gradient(circle at 18% 18%, rgba(59, 130, 246, 0.22) 0%, transparent 42%),
    radial-gradient(circle at 82% 78%, rgba(6, 182, 212, 0.18) 0%, transparent 44%),
    radial-gradient(circle at 50% 120%, rgba(99, 102, 241, 0.14) 0%, transparent 55%),
    linear-gradient(rgba(148, 163, 184, 0.08) 1px, transparent 1px),
    linear-gradient(90deg, rgba(148, 163, 184, 0.08) 1px, transparent 1px),
    linear-gradient(180deg, rgba(2, 6, 23, 0.20), rgba(2, 6, 23, 0.80));
  background-size: auto, auto, auto, 26px 26px, 26px 26px, auto;
  background-position: center, center, center, center, center, center;
  min-height: 100vh;
  overscroll-behavior-y: none;
}


    .glass {
  background: var(--surface);
  backdrop-filter: blur(18px);
  -webkit-backdrop-filter: blur(18px);
  border: 1px solid var(--border);
  box-shadow: var(--shadow-soft);
  position: relative;
  overflow: hidden;
}
.glass::before{
  content:"";
  position:absolute; inset:-2px;
  background:
    radial-gradient(120px 120px at 18% 22%, rgba(59,130,246,0.18), transparent 55%),
    radial-gradient(120px 120px at 84% 78%, rgba(6,182,212,0.14), transparent 60%);
  pointer-events:none;
  filter: blur(2px);
  opacity: 0.9;
}
.glass::after{
  content:"";
  position:absolute; inset:0;
  border-radius: inherit;
  pointer-events:none;
  box-shadow:
    inset 0 0 0 1px rgba(255,255,255,0.10),
    inset 0 0 0 2px rgba(2, 6, 23, 0.35);
}

    .field {
  background: rgba(2, 6, 23, 0.45);
  border: 1px solid rgba(148, 163, 184, 0.18);
  color: var(--text-main);
  transition: all 0.18s ease;
  box-shadow: inset 0 1px 0 rgba(255,255,255,0.05);
  backdrop-filter: blur(12px);
  -webkit-backdrop-filter: blur(12px);
}
.field::placeholder { color: rgba(148, 163, 184, 0.55); }
.field:hover { border-color: rgba(59, 130, 246, 0.35); }
.field:focus {
  background: rgba(2, 6, 23, 0.62);
  border-color: rgba(6, 182, 212, 0.55);
  box-shadow: var(--ring);
  outline: none;
}

    .custom-select-trigger { display: flex; justify-content: space-between; align-items: center; cursor: pointer; }

    .custom-options {
  position: absolute; top: 108%; left: 0; right: 0;
  background: rgba(2, 6, 23, 0.88);
  backdrop-filter: blur(16px);
  -webkit-backdrop-filter: blur(16px);
  border-radius: 1.5rem;
  border: 1px solid rgba(148, 163, 184, 0.18);
  box-shadow: var(--shadow);
  z-index: 999;
  opacity: 0; visibility: hidden;
  transform: translateY(-10px);
  transition: all 0.18s cubic-bezier(0.16, 1, 0.3, 1);
  max-height: 320px;
  overflow-y: auto;
  padding: 0.5rem;
  scrollbar-width: thin;
  scrollbar-color: rgba(148, 163, 184, 0.55) transparent;
}
.custom-options.open { opacity: 1; visibility: visible; transform: translateY(0); }

    .custom-option {
  padding: 0.75rem 0.9rem;
  border-radius: 1rem;
  cursor: pointer;
  display: flex;
  align-items: center;
  gap: 0.75rem;
  transition: background 0.15s ease, transform 0.15s ease;
  color: rgba(226, 232, 240, 0.95);
}
.custom-option:hover { background: rgba(148, 163, 184, 0.10); transform: translateY(-1px); }
.custom-option.selected { background: rgba(6, 182, 212, 0.14); color: rgba(226, 232, 240, 0.98); font-weight: 700; }

    .option-icon {
  width: 2rem; height: 2rem;
  display: flex; align-items: center; justify-content: center;
  border-radius: 0.75rem;
  background: rgba(148, 163, 184, 0.10);
  color: rgba(226, 232, 240, 0.78);
  transition: all 0.15s ease;
  border: 1px solid rgba(148, 163, 184, 0.14);
}
.custom-option.selected .option-icon {
  background: rgba(59, 130, 246, 0.16);
  color: rgba(226, 232, 240, 0.96);
  border-color: rgba(6, 182, 212, 0.22);
  box-shadow: 0 10px 24px rgba(6, 182, 212, 0.12);
}

    .type-neutral { background: rgba(2, 6, 23, 0.04); color: var(--text-muted); border: 1px solid transparent; }
    .type-active-exp {
  background: #ef4444 !important; /* solid red */
  color: rgba(255,255,255,0.98) !important;
  border: 1px solid rgba(255,255,255,0.18) !important;
  box-shadow: 0 14px 30px rgba(239, 68, 68, 0.35) !important;
  backdrop-filter: none !important;
}
    .type-active-inc {
  background: #10b981 !important; /* solid green */
  color: rgba(255,255,255,0.98) !important;
  border: 1px solid rgba(255,255,255,0.18) !important;
  box-shadow: 0 14px 30px rgba(16, 185, 129, 0.35) !important;
  backdrop-filter: none !important;
}

    .tab-active {
  background: linear-gradient(135deg, rgba(59, 130, 246, 0.22), rgba(6, 182, 212, 0.18));
  color: rgba(226, 232, 240, 0.98);
  box-shadow: 0 10px 26px rgba(6, 182, 212, 0.16);
  border: 1px solid rgba(6, 182, 212, 0.22);
}
.tab-inactive { background: transparent; color: rgba(148, 163, 184, 0.90); }

    .btn-primary-grad {
  background: linear-gradient(135deg, var(--primary) 0%, #1d4ed8 55%, var(--primary-2) 130%);
  color: white;
  box-shadow: 0 18px 42px rgba(59, 130, 246, 0.24), 0 10px 28px rgba(6, 182, 212, 0.12);
  border: 1px solid rgba(255,255,255,0.10);
  transition: transform 0.14s ease, filter 0.14s ease, box-shadow 0.14s ease;
}
.btn-primary-grad:hover { filter: brightness(1.04); box-shadow: 0 22px 54px rgba(59, 130, 246, 0.28), 0 14px 38px rgba(6, 182, 212, 0.14); }
.btn-primary-grad:active { transform: scale(0.985); }

    .card-hover { transition: transform 0.16s ease, box-shadow 0.16s ease, border-color 0.16s ease; }
    .card-hover:hover { transform: translateY(-1px); box-shadow: 0 14px 26px rgba(2, 6, 23, 0.08); border-color: rgba(37, 99, 235, 0.16); }

/* ==============================
   FinTech Dark Glass Overrides
   (UI only ‚Äî no functional changes)
   ============================== */
.theme-fintech .text-slate-900{ color: rgba(226,232,240,0.98) !important; }
.theme-fintech .text-slate-800{ color: rgba(226,232,240,0.94) !important; }
.theme-fintech .text-slate-700{ color: rgba(203,213,225,0.92) !important; }
.theme-fintech .text-slate-600{ color: rgba(186,199,214,0.92) !important; }
.theme-fintech .text-slate-500{ color: rgba(148,163,184,0.92) !important; }
.theme-fintech .text-slate-400{ color: rgba(148,163,184,0.78) !important; }
.theme-fintech .text-slate-300{ color: rgba(148,163,184,0.66) !important; }
.theme-fintech .text-slate-200{ color: rgba(148,163,184,0.56) !important; }

.theme-fintech .text-blue-600{ color: rgba(125,211,252,0.95) !important; }
.theme-fintech .text-emerald-600{ color: rgba(110,231,183,0.95) !important; }
.theme-fintech .text-rose-600{ color: rgba(251,113,133,0.95) !important; }
.theme-fintech .text-orange-600{ color: rgba(253,186,116,0.95) !important; }

.theme-fintech .bg-white,
.theme-fintech .bg-white\/92,
.theme-fintech .bg-white\/90,
.theme-fintech .bg-white\/70,
.theme-fintech .bg-white\/60,
.theme-fintech .bg-white\/10{
  background-color: rgba(255,255,255,0.06) !important;
}

.theme-fintech .border-slate-100,
.theme-fintech .border-slate-200,
.theme-fintech .border-slate-200\/60,
.theme-fintech .border-slate-100\/80{
  border-color: rgba(148,163,184,0.14) !important;
}

.theme-fintech .bg-slate-100{ background-color: rgba(148,163,184,0.10) !important; }
.theme-fintech .bg-slate-200{ background-color: rgba(148,163,184,0.12) !important; }

.theme-fintech .bg-blue-50{ background-color: rgba(59,130,246,0.12) !important; }
.theme-fintech .bg-blue-100{ background-color: rgba(59,130,246,0.16) !important; }
.theme-fintech .border-blue-100{ border-color: rgba(6,182,212,0.22) !important; }

.theme-fintech .bg-emerald-100{ background-color: rgba(16,185,129,0.14) !important; }
.theme-fintech .border-emerald-200\/60{ border-color: rgba(16,185,129,0.22) !important; }

.theme-fintech .bg-rose-50{ background-color: rgba(244,63,94,0.12) !important; }
.theme-fintech .bg-rose-100{ background-color: rgba(244,63,94,0.14) !important; }
.theme-fintech .border-rose-100{ border-color: rgba(244,63,94,0.22) !important; }
.theme-fintech .border-rose-200\/60{ border-color: rgba(244,63,94,0.22) !important; }

.theme-fintech .bg-orange-50{ background-color: rgba(249,115,22,0.14) !important; }
.theme-fintech .border-orange-100{ border-color: rgba(249,115,22,0.22) !important; }
.theme-fintech .bg-orange-100{ background-color: rgba(249,115,22,0.16) !important; }
.theme-fintech .border-orange-200\/60{ border-color: rgba(249,115,22,0.24) !important; }

.theme-fintech .shadow-sm{ box-shadow: 0 12px 34px rgba(0,0,0,0.28) !important; }
.theme-fintech .shadow-xl{ box-shadow: 0 22px 60px rgba(0,0,0,0.48) !important; }
.theme-fintech .shadow-2xl{ box-shadow: 0 28px 80px rgba(0,0,0,0.55) !important; }


/* ==================================================
   Sticky Glass Header Tone (darker ‚Äî match Save button)
   UI only ‚Äî no functional changes
   ================================================== */
.theme-fintech .glass.sticky{
  /* darker fintech glass using Save button hues */
  background-color: rgba(2, 6, 23, 0.72);
  background-image: linear-gradient(135deg,
    rgba(59, 130, 246, 0.30) 0%,
    rgba(29, 78, 216, 0.26) 55%,
    rgba(6, 182, 212, 0.24) 130%);
  border-color: rgba(6, 182, 212, 0.30) !important;
  box-shadow:
    0 26px 78px rgba(0,0,0,0.68),
    0 14px 34px rgba(6,182,212,0.14),
    0 10px 26px rgba(59,130,246,0.10),
    inset 0 0 0 1px rgba(255,255,255,0.10);
}

.theme-fintech .glass.sticky::before{
  background:
    radial-gradient(180px 140px at 14% 24%, rgba(59,130,246,0.36), transparent 60%),
    radial-gradient(170px 140px at 86% 80%, rgba(6,182,212,0.30), transparent 64%),
    linear-gradient(90deg, transparent, rgba(255,255,255,0.06), transparent);
  opacity: 0.95;
}

.theme-fintech .glass.sticky::after{
  box-shadow:
    inset 0 0 0 1px rgba(255,255,255,0.12),
    inset 0 0 0 2px rgba(2, 6, 23, 0.55),
    inset 0 -18px 40px rgba(2, 6, 23, 0.28),
    0 0 0 1px rgba(6,182,212,0.10);
}

/* Sticky header buttons keep subtle contrast */
.theme-fintech #btnQuickRefresh,
.theme-fintech #btnHistRefresh{
  background: rgba(255,255,255,0.10) !important;
  border-color: rgba(148,163,184,0.18) !important;
}
.theme-fintech #btnQuickRefresh:hover,
.theme-fintech #btnHistRefresh:hover{
  background: rgba(6,182,212,0.14) !important;
  border-color: rgba(6,182,212,0.28) !important;
  color: rgba(226,232,240,0.98) !important;
}

@media (prefers-reduced-motion: reduce){
      * { transition: none !important; animation: none !important; }
    }

    @keyframes float {
      0% { transform: translateY(0px); }
      50% { transform: translateY(-5px); }
      100% { transform: translateY(0px); }
    }
    .animate-float { animation: float 3s ease-in-out infinite; }
  
/* === UI override: Expense/Income buttons (inactive = light tone) === */
#btnExp.type-neutral,
#btnInc.type-neutral,
#btnExp:not(.type-active-exp):not(.type-active-inc):not(.type-neutral),
#btnInc:not(.type-active-exp):not(.type-active-inc):not(.type-neutral) {
  background: rgba(255, 255, 255, 0.92) !important;
  color: rgba(15, 23, 42, 0.96) !important;
  border: 1px solid rgba(15, 23, 42, 0.18) !important;
  box-shadow:
    inset 0 1px 0 rgba(255, 255, 255, 0.72),
    0 16px 34px rgba(2, 6, 23, 0.18) !important;
}

/* Force solid active colors for Expense/Income buttons (no blur) */
#btnExp.type-active-exp, #btnInc.type-active-inc {
  backdrop-filter: none !important;
  -webkit-backdrop-filter: none !important;
}

#btnExp.type-neutral:hover,
#btnInc.type-neutral:hover,
#btnExp:not(.type-active-exp):not(.type-active-inc):not(.type-neutral):hover,
#btnInc:not(.type-active-exp):not(.type-active-inc):not(.type-neutral):hover {
  background: rgba(255, 255, 255, 0.98) !important;
  border-color: rgba(15, 23, 42, 0.26) !important;
  transform: translateY(-1px);
}

#btnExp.type-neutral i,
#btnInc.type-neutral i,
#btnExp:not(.type-active-exp):not(.type-active-inc):not(.type-neutral) i,
#btnInc:not(.type-active-exp):not(.type-active-inc):not(.type-neutral) i {
  color: rgba(2, 6, 23, 0.72) !important;
  opacity: 0.75 !important;
}


/* =========================================================
   INPUT TAB ‚Äî SCROLL & DROPDOWN SAFETY
   - Fix: dropdown menus (custom-options) being clipped by .glass overflow
   - Keep logic intact: CSS only
   ========================================================= */
#tab-input{
  padding-bottom: 10rem; /* extra scroll room so dropdowns won't hit the app edge */
}

/* Allow dropdown panels to escape glass clipping inside Input tab only */
#tab-input .glass{
  overflow: visible;
}

/* Prevent the decorative border layer from spilling when overflow is visible */
#tab-input .glass::before{
  inset: 0;
}

</style>
</head>

<body class="theme-fintech p-4 pb-12 sm:p-6 lg:p-8 flex justify-center">

  <div class="w-full max-w-md space-y-6 relative z-10">

    <div class="glass rounded-[2rem] p-5 sticky top-2 z-50">
      <div class="flex items-center justify-between">
        <div class="flex items-center gap-3">
          <div class="w-10 h-10 rounded-2xl bg-gradient-to-br from-blue-600 to-cyan-500 flex items-center justify-center text-white shadow-lg shadow-blue-600/20">
            <i class="fa-solid fa-piggy-bank text-lg"></i>
          </div>
          <div>
            <h1 class="text-xl font-bold tracking-tight text-slate-900">My Piggy</h1>
            <p class="text-[11px] font-medium text-slate-400 uppercase tracking-wider">Financial Tracker</p>
          </div>
        </div>

        <button id="btnQuickRefresh" class="w-9 h-9 rounded-full bg-white/70 border border-slate-200 text-slate-500 hover:bg-blue-50 hover:text-blue-600 transition-colors flex items-center justify-center shadow-sm">
          <i class="fa-solid fa-arrows-rotate text-sm"></i>
        </button>
      </div>

      <div class="mt-5 bg-white/60 border border-slate-200/60 p-1.5 rounded-2xl grid grid-cols-3 gap-1 relative">
        <button id="tabBtnDash" class="py-2.5 rounded-xl text-xs font-bold transition-all duration-200 tab-active" onclick="switchTab('dashboard')">Dashboard</button>
        <button id="tabBtnInput" class="py-2.5 rounded-xl text-xs font-bold transition-all duration-200 tab-inactive" onclick="switchTab('input')">Input</button>
        <button id="tabBtnHistory" class="py-2.5 rounded-xl text-xs font-bold transition-all duration-200 tab-inactive" onclick="switchTab('history')">History</button>
      </div>
    </div>

    <!-- ===================== INPUT TAB ===================== -->
    <div id="tab-input" class="space-y-4">
      <div class="glass rounded-[2.5rem] p-6 pt-8 space-y-6 relative">
        <div class="absolute -top-10 -right-10 w-32 h-32 bg-blue-500/10 rounded-full blur-3xl pointer-events-none"></div>

        <div class="grid grid-cols-2 gap-3">
          <div class="space-y-1.5">
            <label class="text-[10px] font-bold text-slate-400 uppercase ml-2">Date</label>
            <div class="relative">
              <input type="date" id="txDate" class="field w-full rounded-2xl px-3 py-2.5 text-sm font-medium text-slate-700 appearance-none text-center">
            </div>
          </div>

          <div class="space-y-1.5 relative">
            <label class="text-[10px] font-bold text-slate-400 uppercase ml-2">User</label>

            <select id="userName" class="hidden" required>
              <option value="" selected disabled>Select User</option>
              <option value="Nine">Nine</option>
              <option value="Bow">Bow</option>
            </select>

            <div id="custom-user-trigger" class="field w-full rounded-2xl px-3 py-2.5 text-sm font-medium text-slate-800 custom-select-trigger" onclick="toggleCustomSelect(event,'user')">
              <span class="flex items-center gap-3">
                <!-- ‚úÖ user-trigger-icon ‡∏™‡∏µ‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏Å‡∏±‡∏ô‡∏Å‡∏±‡∏ö dashUser-trigger-icon -->
                <span id="user-trigger-icon" class="w-8 h-8 rounded-lg bg-slate-100 text-slate-400 flex items-center justify-center border border-slate-200">
                  <i class="fa-solid fa-user text-sm"></i>
                </span>
                <span id="user-trigger-text" class="text-slate-400">Select User</span>
              </span>
              <i id="user-trigger-arrow" class="fa-solid fa-chevron-down text-slate-300 text-xs transition-transform"></i>
            </div>

            <div id="custom-user-options" class="custom-options"></div>
          </div>
        </div>

        <div class="grid grid-cols-2 gap-3">
          <button onclick="setType('Expense')" id="btnExp" class="type-neutral py-4 rounded-2xl font-bold text-sm transition-all flex flex-col items-center gap-1 group">
            <i class="fa-solid fa-arrow-trend-down text-lg mb-1 opacity-50 group-hover:opacity-100"></i>
            ‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢
          </button>
          <button onclick="setType('Income')" id="btnInc" class="type-neutral py-4 rounded-2xl font-bold text-sm transition-all flex flex-col items-center gap-1 group">
            <i class="fa-solid fa-arrow-trend-up text-lg mb-1 opacity-50 group-hover:opacity-100"></i>
            ‡∏£‡∏≤‡∏¢‡∏£‡∏±‡∏ö
          </button>
        </div>

        <div class="relative group">
          <div class="absolute left-5 top-1/2 -translate-y-1/2 text-slate-400 text-lg font-light">‡∏ø</div>
          <input type="number" id="amt" inputmode="decimal"
                 class="field w-full p-6 pl-10 rounded-[2rem] text-3xl font-bold text-slate-800 placeholder:text-slate-200 text-center tracking-tight focus:ring-4 focus:ring-blue-100"
                 placeholder="0">
          <p class="text-center text-[10px] text-slate-400 mt-2 font-medium">‡∏£‡∏∞‡∏ö‡∏∏‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô</p>
        </div>

        
        <!-- Payment Method -->
        <div class="space-y-1.5">
          <label class="text-[10px] font-bold text-slate-400 uppercase ml-2">Payment Method</label>

          <!-- hidden select (source of truth) -->
          <select id="payMethod" class="hidden">
            <option value="" disabled selected>‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏à‡πà‡∏≤‡∏¢</option>
            <option value="‡πÄ‡∏á‡∏¥‡∏ô‡∏™‡∏î">‡πÄ‡∏á‡∏¥‡∏ô‡∏™‡∏î</option>
            <option value="‡πÄ‡∏á‡∏¥‡∏ô Digital">‡πÄ‡∏á‡∏¥‡∏ô Digital</option>
          </select>

          <!-- custom trigger (UI only) -->
          <div class="relative">
            <div id="custom-payMethod-trigger" class="field w-full p-4 rounded-2xl text-slate-800 font-medium custom-select-trigger" onclick="toggleCustomSelect(event,'payMethod')">
              <span class="flex items-center gap-3">
                <span id="payMethod-trigger-icon" class="w-8 h-8 rounded-lg bg-gradient-to-br from-amber-400 via-orange-500 to-rose-500 text-white flex items-center justify-center shadow-sm">
                  <i class="fa-solid fa-credit-card text-sm"></i>
                </span>
                <span id="payMethod-trigger-text" class="text-slate-400">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏à‡πà‡∏≤‡∏¢</span>
              </span>
              <i id="payMethod-trigger-arrow" class="fa-solid fa-chevron-down text-slate-300 text-xs transition-transform"></i>
            </div>
            <div id="custom-payMethod-options" class="custom-options"></div>
          </div>
        </div>

<div class="space-y-3 relative">
          <select id="cate" class="hidden">
            <option value="" disabled selected>Select Category</option>
            <option value="üç± ‡∏≠‡∏≤‡∏´‡∏≤‡∏£/‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏î‡∏∑‡πà‡∏°">‡∏≠‡∏≤‡∏´‡∏≤‡∏£ / ‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏î‡∏∑‡πà‡∏°</option>
            <option value="üöó ‡∏Å‡∏≤‡∏£‡πÄ‡∏î‡∏¥‡∏ô‡∏ó‡∏≤‡∏á">‡∏Å‡∏≤‡∏£‡πÄ‡∏î‡∏¥‡∏ô‡∏ó‡∏≤‡∏á / ‡∏Ñ‡πà‡∏≤‡∏ô‡πâ‡∏≥‡∏°‡∏±‡∏ô</option>
            <option value="üè† ‡∏ó‡∏µ‡πà‡∏û‡∏±‡∏Å/‡∏Ç‡∏≠‡∏á‡πÉ‡∏ä‡πâ">‡∏ó‡∏µ‡πà‡∏û‡∏±‡∏Å / ‡∏Ç‡∏≠‡∏á‡πÉ‡∏ä‡πâ‡∏™‡πà‡∏ß‡∏ô‡∏ï‡∏±‡∏ß</option>
            <option value="üõçÔ∏è ‡∏ä‡πâ‡∏≠‡∏õ‡∏õ‡∏¥‡πâ‡∏á">‡∏ä‡πâ‡∏≠‡∏õ‡∏õ‡∏¥‡πâ‡∏á / ‡∏ö‡∏±‡∏ô‡πÄ‡∏ó‡∏¥‡∏á</option>

            <!-- ‚úÖ 4 ‡∏´‡∏°‡∏ß‡∏î‡πÄ‡∏á‡∏¥‡∏ô‡∏≠‡∏≠‡∏° -->
            <option value="üí∞ ‡πÄ‡∏á‡∏¥‡∏ô‡∏≠‡∏≠‡∏°‡πÅ‡∏ö‡∏ö‡πÄ‡∏á‡∏¥‡∏ô‡∏ï‡∏£‡∏≤‡πÑ‡∏ó‡∏¢ THB">‡πÄ‡∏á‡∏¥‡∏ô‡∏≠‡∏≠‡∏°‡πÅ‡∏ö‡∏ö‡πÄ‡∏á‡∏¥‡∏ô‡∏ï‡∏£‡∏≤‡πÑ‡∏ó‡∏¢ THB</option>
            <option value="üíµ ‡πÄ‡∏á‡∏¥‡∏ô‡∏≠‡∏≠‡∏°‡πÅ‡∏ö‡∏ö‡πÄ‡∏á‡∏¥‡∏ô‡∏ï‡∏£‡∏≤‡∏ï‡πà‡∏≤‡∏á‡∏õ‡∏£‡∏∞‡πÄ‡∏ó‡∏® USD">‡πÄ‡∏á‡∏¥‡∏ô‡∏≠‡∏≠‡∏°‡πÅ‡∏ö‡∏ö‡πÄ‡∏á‡∏¥‡∏ô‡∏ï‡∏£‡∏≤‡∏ï‡πà‡∏≤‡∏á‡∏õ‡∏£‡∏∞‡πÄ‡∏ó‡∏® USD</option>
            <option value="üõ°Ô∏è ‡πÄ‡∏á‡∏¥‡∏ô‡∏≠‡∏≠‡∏°‡πÅ‡∏ö‡∏ö‡∏õ‡∏£‡∏∞‡∏Å‡∏±‡∏ô‡∏™‡∏∞‡∏™‡∏°‡∏ó‡∏£‡∏±‡∏û‡∏¢‡πå">‡πÄ‡∏á‡∏¥‡∏ô‡∏≠‡∏≠‡∏°‡πÅ‡∏ö‡∏ö‡∏õ‡∏£‡∏∞‡∏Å‡∏±‡∏ô‡∏™‡∏∞‡∏™‡∏°‡∏ó‡∏£‡∏±‡∏û‡∏¢‡πå</option>
            <option value="ü™ô ‡∏≠‡∏≠‡∏°‡∏ó‡∏≠‡∏á">‡∏≠‡∏≠‡∏°‡∏ó‡∏≠‡∏á</option>

            <option value="üíµ ‡∏£‡∏≤‡∏¢‡∏£‡∏±‡∏ö/‡πÇ‡∏ö‡∏ô‡∏±‡∏™">‡∏£‡∏≤‡∏¢‡∏£‡∏±‡∏ö / ‡πÄ‡∏á‡∏¥‡∏ô‡πÄ‡∏î‡∏∑‡∏≠‡∏ô / ‡πÇ‡∏ö‡∏ô‡∏±‡∏™</option>
            <option value="‚öôÔ∏è ‡∏≠‡∏∑‡πà‡∏ô‡πÜ">‡∏≠‡∏∑‡πà‡∏ô‡πÜ</option>
          </select>

          <div id="custom-cate-trigger" class="field w-full p-4 rounded-2xl text-slate-800 font-medium custom-select-trigger" onclick="toggleCustomDropdown(event)">
            <span class="flex items-center gap-3">
              <span id="trigger-icon" class="w-8 h-8 rounded-lg bg-gradient-to-br from-amber-400 via-orange-500 to-rose-500 text-white flex items-center justify-center shadow-sm">
                <i class="fa-solid fa-folder-open text-sm drop-shadow-sm"></i>
              </span>
              <span id="trigger-text" class="text-slate-400">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà...</span>
            </span>
            <i class="fa-solid fa-chevron-down text-slate-300 text-xs transition-transform" id="trigger-arrow"></i>
          </div>

          <div id="custom-cate-options" class="custom-options"></div>

          <div class="relative mt-3">
            <input type="text" id="desc" class="field w-full p-4 pl-12 rounded-2xl text-slate-700" placeholder="‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ä‡πà‡∏ß‡∏¢‡∏à‡∏≥ (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ)">
            <i class="fa-regular fa-comment-dots absolute left-5 top-1/2 -translate-y-1/2 text-slate-400"></i>
          </div>
        </div>

        <button onclick="saveData()" id="saveBtn" class="btn btn-primary-grad w-full py-4 rounded-[1.5rem] font-bold text-lg flex items-center justify-center gap-2 mt-4">
          <span>‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</span>
          <i class="fa-solid fa-check circle-check"></i>
        </button>
      </div>
    </div>

    <!-- ===================== DASHBOARD TAB ===================== -->
    <div id="tab-dashboard" class="hidden space-y-5">
      <div class="glass rounded-[2rem] p-5 relative z-[60] overflow-visible">
        <div class="flex items-center justify-between mb-4">
          <h2 class="text-lg font-bold text-slate-800">Overview</h2>
          <button id="btnRefresh" class="text-xs font-bold text-blue-600 bg-blue-50 border border-blue-100 px-3 py-1.5 rounded-full hover:bg-blue-100 transition-colors">Refresh</button>
        </div>

        <div class="grid grid-cols-2 gap-3">
          <select id="dashUser" class="hidden">
            <option value="All" selected>All Users</option>
            <option value="Nine">Nine</option>
            <option value="Bow">Bow</option>
          </select>

          <div class="relative">
            <div id="custom-dashUser-trigger" class="field w-full rounded-xl px-3 py-2 text-xs font-bold text-slate-700 custom-select-trigger" onclick="toggleCustomSelect(event,'dashUser')">
              <span class="flex items-center gap-2">
                <span id="dashUser-trigger-icon" class="w-7 h-7 rounded-lg bg-slate-100 text-slate-400 flex items-center justify-center border border-slate-200">
                  <i class="fa-solid fa-users text-xs"></i>
                </span>
                <span id="dashUser-trigger-text" class="text-slate-900 font-bold">All Users</span>
              </span>
              <i id="dashUser-trigger-arrow" class="fa-solid fa-chevron-down text-slate-300 text-[10px] transition-transform"></i>
            </div>
            <div id="custom-dashUser-options" class="custom-options"></div>
          </div>

          <select id="dashYear" class="field w-full rounded-xl px-3 py-2 text-xs font-bold text-slate-700"></select>
        </div>
      </div>

      <div class="grid grid-cols-1 gap-4">
        <div class="rounded-[2.5rem] p-6 text-white relative overflow-hidden shadow-xl shadow-blue-500/20 isolation-isolate z-0"
             style="background: linear-gradient(120deg, #2563eb, #06b6d4);">
          <div class="absolute top-0 right-0 w-32 h-32 bg-white/10 rounded-full blur-2xl -mr-10 -mt-10 pointer-events-none"></div>
          <i class="fa-solid fa-rocket absolute top-4 right-5 text-7xl text-white/10 rotate-45 pointer-events-none"></i>

                    <div class="flex items-start justify-between gap-4">
            <div class="min-w-0">
              <p class="text-blue-100 text-xs font-medium uppercase tracking-wide mb-1">Net Balance (Year)</p>
              <h2 id="kpiNet" class="text-4xl font-bold tracking-tight mb-4">‡∏ø 0</h2>
              <div class="flex items-center gap-4 text-xs font-medium text-blue-50 bg-white/10 p-2 rounded-xl backdrop-blur-sm inline-flex border border-white/10">
                <span>Income - Expense</span>
              </div>
            </div>

            <!-- Breakdown: Cash / Digital -->
            <div class="shrink-0 w-[44%] max-w-[175px]">
              <div class="bg-white/10 p-3 rounded-[1.25rem] backdrop-blur-sm border border-white/10">
                <p class="text-[10px] text-blue-100/90 font-bold uppercase tracking-wide">Breakdown</p>
                <div class="mt-2 space-y-2">
                  <div class="flex items-center justify-between text-xs font-bold">
                    <span class="text-blue-50/90">‡πÄ‡∏á‡∏¥‡∏ô‡∏™‡∏î</span>
                    <span id="kpiNetCash" class="text-white whitespace-nowrap">‡∏ø 0</span>
                  </div>
                  <div class="h-px bg-white/10"></div>
                  <div class="flex items-center justify-between text-xs font-bold">
                    <span class="text-blue-50/90">‡πÄ‡∏á‡∏¥‡∏ô Digital</span>
                    <span id="kpiNetDigital" class="text-white whitespace-nowrap">‡∏ø 0</span>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <div class="grid grid-cols-2 gap-3">
          <div class="bg-white/90 backdrop-blur p-4 rounded-[1.5rem] border border-slate-100 shadow-sm card-hover">
            <div class="w-8 h-8 rounded-full bg-emerald-100 text-emerald-600 flex items-center justify-center text-xs mb-2 border border-emerald-200/60">
              <i class="fa-solid fa-sack-dollar"></i>
            </div>
            <p class="text-[10px] text-slate-400 uppercase font-bold">Savings</p>
            <h3 id="kpiSavings" class="text-lg font-bold text-emerald-600">‡∏ø 0</h3>
          </div>

          <div class="bg-white/90 backdrop-blur p-4 rounded-[1.5rem] border border-slate-100 shadow-sm card-hover">
            <div class="w-8 h-8 rounded-full bg-slate-100 text-slate-700 flex items-center justify-center text-xs mb-2 border border-slate-200/70">
              <i class="fa-solid fa-scale-balanced"></i>
            </div>
            <p class="text-[10px] text-slate-400 uppercase font-bold">Total Balance</p>
            <h3 id="kpiOverallBalance" class="text-lg font-bold text-slate-900">‡∏ø 0</h3>
          </div>
        </div>

        <div class="grid grid-cols-2 gap-3">
          <div class="bg-white/90 backdrop-blur p-4 rounded-[1.5rem] border border-slate-100 shadow-sm flex flex-col justify-between card-hover">
            <p class="text-[10px] text-slate-400 uppercase font-bold">Total Income</p>
            <p id="kpiIncome" class="text-base font-bold text-emerald-600">‡∏ø 0</p>
          </div>
          <div class="bg-white/90 backdrop-blur p-4 rounded-[1.5rem] border border-slate-100 shadow-sm flex flex-col justify-between card-hover">
            <p class="text-[10px] text-slate-400 uppercase font-bold">Total Expense</p>
            <p id="kpiExpense" class="text-base font-bold text-rose-600">‡∏ø 0</p>
          </div>
        </div>
      </div>

      <div class="glass rounded-[2.5rem] p-5 space-y-6">
        <div>
          <div class="flex items-center justify-between mb-3">
            <h3 class="font-bold text-slate-800 text-sm">Monthly Breakdown</h3>
            <span id="rangeHint" class="text-[10px] text-slate-500 bg-white/70 border border-slate-200 px-2 py-1 rounded-lg">-</span>
          </div>
          <div class="h-[200px] w-full">
            <canvas id="barChart"></canvas>
          </div>
        </div>

        <div class="border-t border-slate-100/80 pt-5">
          <div class="flex items-center justify-between mb-3">
            <div class="flex items-center gap-2">
              <h3 class="font-bold text-slate-800 text-sm">Savings Trend</h3>
              <span id="trendEmoji" class="text-base"></span>
            </div>

            <button onclick="openTargetModal()" class="flex items-center gap-1.5 bg-orange-50 text-orange-600 px-2.5 py-1 rounded-lg text-[10px] font-bold border border-orange-100 hover:bg-orange-100 transition-colors">
              <i class="fa-solid fa-crosshairs"></i> Set Goal
            </button>
          </div>
          <div class="h-[180px] w-full">
            <canvas id="lineChart"></canvas>
          </div>
        </div>

        <!-- ‚úÖ Expense By Category: ‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢‡∏ó‡∏µ‡πà "‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà" ‡πÄ‡∏á‡∏¥‡∏ô‡∏≠‡∏≠‡∏° -->
        <div class="border-t border-slate-100/80 pt-5">
          <div class="flex items-center justify-between mb-3">
            <h3 class="font-bold text-slate-800 text-sm">Expense By Category</h3>
            <span class="text-[10px] text-slate-400">% Share</span>
          </div>
          <div class="h-[220px] w-full relative">
            <canvas id="donutChart"></canvas>
          </div>
        </div>

        <!-- ‚úÖ Donut ‡πÉ‡∏´‡∏°‡πà: ‡∏™‡∏±‡∏î‡∏™‡πà‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô‡∏≠‡∏≠‡∏°‡πÅ‡∏ï‡πà‡∏•‡∏∞‡∏ä‡∏ô‡∏¥‡∏î -->
        <div class="border-t border-slate-100/80 pt-5">
          <div class="flex items-center justify-between mb-3">
            <h3 class="font-bold text-slate-800 text-sm">Savings By Type</h3>
            <span class="text-[10px] text-slate-400">% Share</span>
          </div>
          <div class="h-[220px] w-full relative">
            <canvas id="savingsDonutChart"></canvas>
          </div>
        </div>

      </div>
    </div>

    <!-- ===================== HISTORY TAB ===================== -->
    <div id="tab-history" class="hidden space-y-5">
      <div class="glass rounded-[2rem] p-5 sticky top-24 z-40">
        <div class="flex items-center justify-between mb-3">
          <h2 class="text-lg font-bold text-slate-800">Transactions</h2>
          <button id="btnHistRefresh" class="w-9 h-9 rounded-full bg-white/70 border border-slate-200 hover:bg-blue-50 text-slate-500 hover:text-blue-600 transition-colors flex items-center justify-center shadow-sm">
            <i class="fa-solid fa-rotate-right text-xs"></i>
          </button>
        </div>

        <div class="flex gap-2">
          <select id="histUser" class="hidden">
            <option value="All" selected>All Users</option>
            <option value="Nine">Nine</option>
            <option value="Bow">Bow</option>
          </select>

          <div class="relative flex-1">
            <div id="custom-histUser-trigger" class="field w-full rounded-xl px-2 py-2 text-xs font-bold text-slate-700 text-center custom-select-trigger" onclick="toggleCustomSelect(event,'histUser')">
              <span class="flex items-center gap-2">
                <span id="histUser-trigger-icon" class="w-7 h-7 rounded-lg bg-slate-100 text-slate-400 flex items-center justify-center border border-slate-200">
                  <i class="fa-regular fa-user text-xs"></i>
                </span>
                <span id="histUser-trigger-text" class="text-slate-900 font-bold">All Users</span>
              </span>
              <i id="histUser-trigger-arrow" class="fa-solid fa-chevron-down text-slate-300 text-[10px] transition-transform"></i>
            </div>
            <div id="custom-histUser-options" class="custom-options"></div>
          </div>

          <select id="histYear" class="field flex-1 rounded-xl px-2 py-2 text-xs font-bold text-slate-700 text-center"></select>
        </div>
      </div>

      <div id="history-list" class="space-y-3 pb-10 px-1"></div>
    </div>

  </div>

  <div id="loadingOverlay" class="fixed inset-0 z-[9999] hidden flex items-center justify-center">
    <div class="absolute inset-0 bg-slate-900/20 backdrop-blur-sm"></div>
    <div class="bg-white/90 backdrop-blur-xl p-8 rounded-[2rem] shadow-2xl flex flex-col items-center relative z-10 animate-float border border-white/60">
      <div class="w-16 h-16 mb-4 relative">
        <div class="absolute inset-0 rounded-full border-4 border-slate-100"></div>
        <div class="absolute inset-0 rounded-full border-4 border-blue-600 border-t-transparent animate-spin"></div>
        <i class="fa-solid fa-wallet absolute inset-0 m-auto w-fit h-fit text-blue-600 text-xl"></i>
      </div>
      <h3 id="loadingTitle" class="font-bold text-slate-900 text-lg">Processing</h3>
      <p id="loadingSub" class="text-xs text-slate-500 font-medium mt-1">Please wait...</p>
    </div>
  </div>

  <div id="targetModal" class="fixed inset-0 z-[10000] hidden flex items-center justify-center">
    <div class="absolute inset-0 bg-slate-900/30 backdrop-blur-sm" onclick="closeTargetModal()"></div>
    <div class="bg-white w-[85%] max-w-sm p-6 rounded-[2rem] shadow-2xl relative z-10 transform transition-all duration-300 scale-95 opacity-0 border border-white/70" id="targetModalContent">
      <div class="flex justify-between items-center mb-5">
        <div class="flex items-center gap-2">
          <div class="w-8 h-8 rounded-full bg-orange-100 text-orange-600 flex items-center justify-center border border-orange-200/60">
            <i class="fa-solid fa-bullseye text-sm"></i>
          </div>
          <h3 class="font-bold text-slate-900 text-lg">Set Goals</h3>
        </div>
        <button onclick="closeTargetModal()" class="w-9 h-9 rounded-full bg-slate-100 text-slate-500 hover:bg-slate-200 flex items-center justify-center border border-slate-200">
          <i class="fa-solid fa-xmark"></i>
        </button>
      </div>

      <p class="text-xs text-slate-500 mb-4">‡∏£‡∏∞‡∏ö‡∏∏‡∏¢‡∏≠‡∏î‡πÄ‡∏á‡∏¥‡∏ô‡πÄ‡∏Å‡πá‡∏ö‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡πà‡∏≥‡∏ï‡πà‡∏≠‡πÄ‡∏î‡∏∑‡∏≠‡∏ô (Minimum Saving)</p>

      <div class="space-y-4">
        <div>
          <label class="block text-xs font-bold text-slate-600 mb-1 ml-2">Bow's Target</label>
          <div class="relative">
            <span class="absolute left-4 top-1/2 -translate-y-1/2 text-slate-400 text-xs">‡∏ø</span>
            <input type="number" id="targetBowInput" class="field w-full rounded-2xl pl-8 pr-4 py-3 text-sm font-bold text-slate-800" placeholder="0">
          </div>
        </div>
        <div>
          <label class="block text-xs font-bold text-slate-600 mb-1 ml-2">Nine's Target</label>
          <div class="relative">
            <span class="absolute left-4 top-1/2 -translate-y-1/2 text-slate-400 text-xs">‡∏ø</span>
            <input type="number" id="targetNineInput" class="field w-full rounded-2xl pl-8 pr-4 py-3 text-sm font-bold text-slate-800" placeholder="0">
          </div>
        </div>
      </div>

      <button onclick="saveTargets()" class="btn btn-primary-grad w-full py-3 rounded-xl font-bold text-sm mt-6 shadow-lg shadow-blue-500/30">
        Save Goals
      </button>
    </div>
  </div>

  <script>
    // ===========================================
    // CONFIG & UTILS
    // ===========================================
    const API_URL = 'https://script.google.com/macros/s/AKfycbw93WqGQKvqsTY_0BEYrsYThJwtOMpwJ-jOl3Rpf8dGkWkf3YxzVlniBmuLRTylM_Ac0Q/exec';

    // ‚úÖ Savings categories (‡πÉ‡∏ä‡πâ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏£‡∏≠‡∏á donut)
    const SAVINGS_CATEGORIES = [
      "‡πÄ‡∏á‡∏¥‡∏ô‡∏≠‡∏≠‡∏°‡πÅ‡∏ö‡∏ö‡πÄ‡∏á‡∏¥‡∏ô‡∏ï‡∏£‡∏≤‡πÑ‡∏ó‡∏¢ THB",
      "‡πÄ‡∏á‡∏¥‡∏ô‡∏≠‡∏≠‡∏°‡πÅ‡∏ö‡∏ö‡πÄ‡∏á‡∏¥‡∏ô‡∏ï‡∏£‡∏≤‡∏ï‡πà‡∏≤‡∏á‡∏õ‡∏£‡∏∞‡πÄ‡∏ó‡∏® USD",
      "‡πÄ‡∏á‡∏¥‡∏ô‡∏≠‡∏≠‡∏°‡πÅ‡∏ö‡∏ö‡∏õ‡∏£‡∏∞‡∏Å‡∏±‡∏ô‡∏™‡∏∞‡∏™‡∏°‡∏ó‡∏£‡∏±‡∏û‡∏¢‡πå",
      "‡∏≠‡∏≠‡∏°‡∏ó‡∏≠‡∏á"
    ];

function _expensePinkToRedStops() {
  return [
    '#FB7185', // Rose-400: (‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà ‡πÄ‡∏Ç‡πâ‡∏°‡∏Å‡∏ß‡πà‡∏≤‡πÄ‡∏î‡∏¥‡∏°‡∏ô‡∏¥‡∏î‡∏ô‡∏∂‡∏á)
    '#F43F5E', // Rose-500
    '#E11D48', // Rose-600
    '#BE123C', // Rose-700
    '#9F1239', // Rose-800
    '#881337', // Rose-900
    '#7F1D1D', // Red-900: (‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÇ‡∏ó‡∏ô‡πÄ‡∏õ‡πá‡∏ô‡πÅ‡∏î‡∏á‡πÄ‡∏Ç‡πâ‡∏°)
    '#450A0A', // Red-950: (‡πÅ‡∏î‡∏á‡πÄ‡∏•‡∏∑‡∏≠‡∏î‡∏´‡∏°‡∏π)
    '#360808', // Deep Red: (‡∏Å‡∏î‡πÉ‡∏´‡πâ‡∏°‡∏∑‡∏î‡∏•‡∏á‡∏≠‡∏µ‡∏Å)
    '#200303'  // Almost Black: (‡πÄ‡∏Å‡∏∑‡∏≠‡∏ö‡∏î‡∏≥)
  ];
}

// ‚úÖ Savings: ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ó‡∏µ‡πà‡∏ü‡πâ‡∏≤‡∏™‡∏î (Sky-400) ‡πÑ‡∏•‡πà‡πÑ‡∏õ‡∏ô‡πâ‡∏≥‡πÄ‡∏á‡∏¥‡∏ô‡∏•‡∏∂‡∏Å
function _savingsLightBlueToDeepStops() {
  return [
    '#38BDF8', // Sky-400: (‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà ‡πÑ‡∏°‡πà‡∏™‡∏ß‡πà‡∏≤‡∏á‡∏à‡πâ‡∏≤‡∏à‡∏ô‡πÄ‡∏Å‡∏¥‡∏ô‡πÑ‡∏õ)
    '#0EA5E9', // Sky-500
    '#0284C7', // Sky-600
    '#0369A1', // Sky-700
    '#1D4ED8', // Blue-700: (‡∏Ç‡πâ‡∏≤‡∏°‡∏°‡∏≤‡∏ô‡πâ‡∏≥‡πÄ‡∏á‡∏¥‡∏ô‡∏™‡∏î)
    '#1E40AF', // Blue-800
    '#1E3A8A', // Blue-900
    '#172554', // Blue-950: (‡∏ô‡πâ‡∏≥‡πÄ‡∏á‡∏¥‡∏ô‡∏Å‡∏£‡∏°‡∏ó‡πà‡∏≤)
    '#0F172A', // Slate-900: (‡∏ô‡πâ‡∏≥‡πÄ‡∏á‡∏¥‡∏ô‡πÄ‡∏ó‡∏≤‡πÄ‡∏Ç‡πâ‡∏°)
    '#020617'  // Slate-950: (‡∏î‡∏≥‡∏≠‡∏°‡∏ô‡πâ‡∏≥‡πÄ‡∏á‡∏¥‡∏ô‡∏•‡∏∂‡∏Å‡∏™‡∏∏‡∏î)
  ];
}

    function isSavingsCategory(cat) {
      const s = String(cat || '');
      return SAVINGS_CATEGORIES.some(k => s.includes(k));
    }

    const CATEGORIES = [
      { val: "üç± ‡∏≠‡∏≤‡∏´‡∏≤‡∏£/‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏î‡∏∑‡πà‡∏°", label: "‡∏≠‡∏≤‡∏´‡∏≤‡∏£ / ‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏î‡∏∑‡πà‡∏°", icon: "fa-utensils" },
      { val: "üöó ‡∏Å‡∏≤‡∏£‡πÄ‡∏î‡∏¥‡∏ô‡∏ó‡∏≤‡∏á", label: "‡∏Å‡∏≤‡∏£‡πÄ‡∏î‡∏¥‡∏ô‡∏ó‡∏≤‡∏á / ‡∏ô‡πâ‡∏≥‡∏°‡∏±‡∏ô", icon: "fa-gas-pump" },
      { val: "üè† ‡∏ó‡∏µ‡πà‡∏û‡∏±‡∏Å/‡∏Ç‡∏≠‡∏á‡πÉ‡∏ä‡πâ", label: "‡∏ó‡∏µ‡πà‡∏û‡∏±‡∏Å / ‡∏Ç‡∏≠‡∏á‡πÉ‡∏ä‡πâ", icon: "fa-house-chimney" },
      { val: "üõçÔ∏è ‡∏ä‡πâ‡∏≠‡∏õ‡∏õ‡∏¥‡πâ‡∏á", label: "‡∏ä‡πâ‡∏≠‡∏õ‡∏õ‡∏¥‡πâ‡∏á / ‡∏ö‡∏±‡∏ô‡πÄ‡∏ó‡∏¥‡∏á", icon: "fa-bag-shopping" },

      { val: "üí∞ ‡πÄ‡∏á‡∏¥‡∏ô‡∏≠‡∏≠‡∏°‡πÅ‡∏ö‡∏ö‡πÄ‡∏á‡∏¥‡∏ô‡∏ï‡∏£‡∏≤‡πÑ‡∏ó‡∏¢ THB",           label: "‡πÄ‡∏á‡∏¥‡∏ô‡∏≠‡∏≠‡∏°‡πÅ‡∏ö‡∏ö‡πÄ‡∏á‡∏¥‡∏ô‡∏ï‡∏£‡∏≤‡πÑ‡∏ó‡∏¢ THB",           icon: "fa-piggy-bank" },
      { val: "üíµ ‡πÄ‡∏á‡∏¥‡∏ô‡∏≠‡∏≠‡∏°‡πÅ‡∏ö‡∏ö‡πÄ‡∏á‡∏¥‡∏ô‡∏ï‡∏£‡∏≤‡∏ï‡πà‡∏≤‡∏á‡∏õ‡∏£‡∏∞‡πÄ‡∏ó‡∏® USD",   label: "‡πÄ‡∏á‡∏¥‡∏ô‡∏≠‡∏≠‡∏°‡πÅ‡∏ö‡∏ö‡πÄ‡∏á‡∏¥‡∏ô‡∏ï‡∏£‡∏≤‡∏ï‡πà‡∏≤‡∏á‡∏õ‡∏£‡∏∞‡πÄ‡∏ó‡∏® USD",   icon: "fa-dollar-sign" },
      { val: "üõ°Ô∏è ‡πÄ‡∏á‡∏¥‡∏ô‡∏≠‡∏≠‡∏°‡πÅ‡∏ö‡∏ö‡∏õ‡∏£‡∏∞‡∏Å‡∏±‡∏ô‡∏™‡∏∞‡∏™‡∏°‡∏ó‡∏£‡∏±‡∏û‡∏¢‡πå",        label: "‡πÄ‡∏á‡∏¥‡∏ô‡∏≠‡∏≠‡∏°‡πÅ‡∏ö‡∏ö‡∏õ‡∏£‡∏∞‡∏Å‡∏±‡∏ô‡∏™‡∏∞‡∏™‡∏°‡∏ó‡∏£‡∏±‡∏û‡∏¢‡πå",        icon: "fa-shield-halved" },
      { val: "ü™ô ‡∏≠‡∏≠‡∏°‡∏ó‡∏≠‡∏á",                              label: "‡∏≠‡∏≠‡∏°‡∏ó‡∏≠‡∏á",                              icon: "fa-coins" },

      { val: "üíµ ‡∏£‡∏≤‡∏¢‡∏£‡∏±‡∏ö/‡πÇ‡∏ö‡∏ô‡∏±‡∏™", label: "‡∏£‡∏≤‡∏¢‡∏£‡∏±‡∏ö / ‡πÇ‡∏ö‡∏ô‡∏±‡∏™", icon: "fa-money-bill-wave" },
      { val: "‚öôÔ∏è ‡∏≠‡∏∑‡πà‡∏ô‡πÜ", label: "‡∏≠‡∏∑‡πà‡∏ô‡πÜ", icon: "fa-layer-group" }
    ];

    // NO EMOJI: User lists
    const USER_LIST = [
      { val: "Nine", label: "Nine", icon: "fa-user" },
      { val: "Bow",  label: "Bow",  icon: "fa-user" }
    ];
    const DASH_USER_LIST = [
      { val: "All",  label: "All Users", icon: "fa-users" },
      { val: "Nine", label: "Nine",      icon: "fa-user" },
      { val: "Bow",  label: "Bow",       icon: "fa-user" }
    ];
    const HIST_USER_LIST = [
      { val: "All",  label: "All Users", icon: "fa-users" },
      { val: "Nine", label: "Nine",      icon: "fa-user" },
      { val: "Bow",  label: "Bow",       icon: "fa-user" }
    ];

    const PAY_METHOD_LIST = [
      { val: "‡πÄ‡∏á‡∏¥‡∏ô‡∏™‡∏î",      label: "‡πÄ‡∏á‡∏¥‡∏ô‡∏™‡∏î",      icon: "fa-coins" },
      { val: "‡πÄ‡∏á‡∏¥‡∏ô Digital", label: "‡πÄ‡∏á‡∏¥‡∏ô Digital", icon: "fa-mobile-screen" }
    ];


    async function apiCall(action, params) {
      const body = new URLSearchParams();
      body.append('action', action);
      const p = params || {};
      Object.keys(p).forEach(k => body.append(k, p[k] == null ? '' : String(p[k])));
      const resp = await fetch(API_URL, { method: 'POST', body });
      const text = await resp.text();
      let json;
      try { json = JSON.parse(text); }
      catch (e) { throw new Error('API ‡∏ï‡∏≠‡∏ö‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà JSON: ' + text.slice(0, 200)); }
      return json;
    }

    let currentType = '';
    let barChart = null;
    let lineChart = null;
    let donutChart = null;
    let savingsDonutChart = null;

    const MONTH_LABELS = ["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"];
    let __loadingCount = 0;

    // --- TARGET LOGIC ---
    let targetNine = 0;
    let targetBow = 0;

    function loadTargets() {
      targetNine = parseFloat(localStorage.getItem('myPiggy_targetNine')) || 0;
      targetBow  = parseFloat(localStorage.getItem('myPiggy_targetBow'))  || 0;
    }

    function openTargetModal() {
      loadTargets();
      document.getElementById('targetNineInput').value = targetNine || '';
      document.getElementById('targetBowInput').value  = targetBow  || '';
      const modal = document.getElementById('targetModal');
      const content = document.getElementById('targetModalContent');
      modal.classList.remove('hidden');
      setTimeout(() => {
        content.classList.remove('scale-95', 'opacity-0');
        content.classList.add('scale-100', 'opacity-100');
      }, 10);
    }

    function closeTargetModal() {
      const modal = document.getElementById('targetModal');
      const content = document.getElementById('targetModalContent');
      content.classList.remove('scale-100', 'opacity-100');
      content.classList.add('scale-95', 'opacity-0');
      setTimeout(() => { modal.classList.add('hidden'); }, 200);
    }

    function saveTargets() {
      const n = parseFloat(document.getElementById('targetNineInput').value) || 0;
      const b = parseFloat(document.getElementById('targetBowInput').value)  || 0;
      localStorage.setItem('myPiggy_targetNine', n);
      localStorage.setItem('myPiggy_targetBow', b);
      targetNine = n;
      targetBow  = b;
      closeTargetModal();
      if (!document.getElementById('tab-dashboard').classList.contains('hidden')) refreshDashboard();
    }

    // ===========================================
    // MAIN FLOW
    // ===========================================
    window.onload = () => {
      bindGlobalRefresh();
      initDateDefaultToday();
      initYearSelector('dashYear');
      initYearSelector('histYear');
      bindDashboardControls();
      bindHistoryControls();
      initCustomDropdown();
      initUserSelectDropdowns();
      loadTargets();

      refreshDashboard();
      resetTypeSelection();
      resetUserSelection();
      switchTab('dashboard');
    };

    // ===========================================
    // CATEGORY DROPDOWN
    // ===========================================
    function initCustomDropdown() {
      const container = document.getElementById('custom-cate-options');
      container.innerHTML = '';
      CATEGORIES.forEach(cat => {
        const div = document.createElement('div');
        div.className = 'custom-option';
        div.onclick = () => selectCustomOption(cat.val, cat.label, cat.icon);
        div.innerHTML = `
          <div class="option-icon"><i class="fa-solid ${cat.icon}"></i></div>
          <span class="font-medium text-sm">${cat.label}</span>
        `;
        container.appendChild(div);
      });
    }

    function toggleCustomDropdown(e) {
      e.stopPropagation();
      closeAllCustomSelects();
      const opts = document.getElementById('custom-cate-options');
      const arrow = document.getElementById('trigger-arrow');
      opts.classList.toggle('open');
      arrow.style.transform = opts.classList.contains('open') ? 'rotate(180deg)' : 'rotate(0deg)';
    }

    function selectCustomOption(value, label, iconClass) {
      document.getElementById('cate').value = value;
      const iconEl = document.getElementById('trigger-icon');
      const textEl = document.getElementById('trigger-text');
      iconEl.innerHTML = `<i class="fa-solid ${iconClass} text-blue-600"></i>`;
      iconEl.className = "w-8 h-8 rounded-lg bg-blue-50 flex items-center justify-center border border-blue-100";
      textEl.innerText = label;
      textEl.className = "text-slate-900 font-bold";
      document.querySelectorAll('#custom-cate-options .custom-option').forEach(el => el.classList.remove('selected'));
      document.getElementById('custom-cate-options').classList.remove('open');
      document.getElementById('trigger-arrow').style.transform = 'rotate(0deg)';
    }

    function resetCustomDropdown() {
      document.getElementById('cate').value = "";
      document.getElementById('trigger-icon').innerHTML = `<i class="fa-solid fa-folder-open text-sm drop-shadow-sm"></i>`;
      document.getElementById('trigger-icon').className = "w-8 h-8 rounded-lg bg-gradient-to-br from-amber-400 via-orange-500 to-rose-500 text-white flex items-center justify-center shadow-sm";
      document.getElementById('trigger-text').innerText = "‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà...";
      document.getElementById('trigger-text').className = "text-slate-400";
    }

    // ===========================================
    // USER/DASH/HIST CUSTOM SELECTS
    // ===========================================
    const __customSelectRegistry = {
      user: {
        selectId: 'userName',
        triggerId: 'custom-user-trigger',
        optionsId: 'custom-user-options',
        iconId: 'user-trigger-icon',
        textId: 'user-trigger-text',
        arrowId: 'user-trigger-arrow',
        items: USER_LIST,
        placeholder: 'Select User',
        placeholderIcon: 'fa-user'
      },
      dashUser: {
        selectId: 'dashUser',
        triggerId: 'custom-dashUser-trigger',
        optionsId: 'custom-dashUser-options',
        iconId: 'dashUser-trigger-icon',
        textId: 'dashUser-trigger-text',
        arrowId: 'dashUser-trigger-arrow',
        items: DASH_USER_LIST,
        placeholder: 'All Users',
        placeholderIcon: 'fa-users'
      },
      histUser: {
        selectId: 'histUser',
        triggerId: 'custom-histUser-trigger',
        optionsId: 'custom-histUser-options',
        iconId: 'histUser-trigger-icon',
        textId: 'histUser-trigger-text',
        arrowId: 'histUser-trigger-arrow',
        items: HIST_USER_LIST,
        placeholder: 'All Users',
        placeholderIcon: 'fa-users'
      },
      payMethod: {
        selectId: 'payMethod',
        triggerId: 'custom-payMethod-trigger',
        optionsId: 'custom-payMethod-options',
        iconId: 'payMethod-trigger-icon',
        textId: 'payMethod-trigger-text',
        arrowId: 'payMethod-trigger-arrow',
        items: PAY_METHOD_LIST,
        placeholder: '‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ä‡πà‡∏≠‡∏á‡∏ó‡∏≤‡∏á‡πÉ‡∏ä‡πâ‡∏à‡πà‡∏≤‡∏¢',
        placeholderIcon: 'fa-credit-card'
      }
    };

    function initUserSelectDropdowns(){
      Object.keys(__customSelectRegistry).forEach(key => buildCustomSelect(key));

      document.addEventListener('click', (e) => {
        const cateTrigger = document.getElementById('custom-cate-trigger');
        const cateOptions = document.getElementById('custom-cate-options');
        if (cateTrigger && cateOptions && !cateTrigger.contains(e.target) && !cateOptions.contains(e.target)) {
          cateOptions.classList.remove('open');
          const a = document.getElementById('trigger-arrow');
          if (a) a.style.transform = 'rotate(0deg)';
        }
        closeAllCustomSelects();
      });

      ['user','dashUser','histUser','payMethod'].forEach(key=>{
        const cfg = __customSelectRegistry[key];
        const sel = document.getElementById(cfg.selectId);
        if(sel){
          sel.addEventListener('change', () => syncCustomSelectUI(key));
          syncCustomSelectUI(key);
        }
      });
    }

    function buildCustomSelect(key){
      const cfg = __customSelectRegistry[key];
      const sel = document.getElementById(cfg.selectId);
      const optionsBox = document.getElementById(cfg.optionsId);
      if(!sel || !optionsBox) return;

      optionsBox.innerHTML = '';
      cfg.items.forEach(it=>{
        const div = document.createElement('div');
        div.className = 'custom-option';
        div.onclick = (ev) => {
          ev.stopPropagation();
          sel.value = it.val;
          sel.dispatchEvent(new Event('change', { bubbles: true }));
          closeCustomSelect(key);
          syncCustomSelectUI(key);
        };
        div.innerHTML = `
          <div class="option-icon"><i class="fa-solid ${it.icon}"></i></div>
          <span class="font-medium text-sm">${escapeHtml(it.label)}</span>
        `;
        optionsBox.appendChild(div);
      });
      syncCustomSelectUI(key);
    }

    function toggleCustomSelect(e, key){
      e.stopPropagation();
      const cateOptions = document.getElementById('custom-cate-options');
      if (cateOptions) {
        cateOptions.classList.remove('open');
        const a = document.getElementById('trigger-arrow');
        if (a) a.style.transform = 'rotate(0deg)';
      }
      Object.keys(__customSelectRegistry).forEach(k => { if(k !== key) closeCustomSelect(k); });

      const cfg = __customSelectRegistry[key];
      const box = document.getElementById(cfg.optionsId);
      const arrow = document.getElementById(cfg.arrowId);
      if(!box || !arrow) return;

      box.classList.toggle('open');
      arrow.style.transform = box.classList.contains('open') ? 'rotate(180deg)' : 'rotate(0deg)';
    }

    function closeCustomSelect(key){
      const cfg = __customSelectRegistry[key];
      const box = document.getElementById(cfg.optionsId);
      const arrow = document.getElementById(cfg.arrowId);
      if(box) box.classList.remove('open');
      if(arrow) arrow.style.transform = 'rotate(0deg)';
    }

    function closeAllCustomSelects(){
      Object.keys(__customSelectRegistry).forEach(k => closeCustomSelect(k));
    }

    function syncCustomSelectUI(key){
      const cfg = __customSelectRegistry[key];
      const sel = document.getElementById(cfg.selectId);
      const iconEl = document.getElementById(cfg.iconId);
      const textEl = document.getElementById(cfg.textId);
      const optionsBox = document.getElementById(cfg.optionsId);
      if(!sel || !iconEl || !textEl) return;

      const val = sel.value || '';
      const found = cfg.items.find(x => x.val === val);

      if(optionsBox){
        const nodes = optionsBox.querySelectorAll('.custom-option');
        nodes.forEach((n) => n.classList.remove('selected'));
        if(found){
          const idx = cfg.items.findIndex(x => x.val === val);
          if(idx >= 0 && nodes[idx]) nodes[idx].classList.add('selected');
        }
      }

      if(!val || !found){
        // UI only: keep Payment Method icon in the same orange tone as Category trigger icon
        if(key === 'payMethod'){
          iconEl.innerHTML = `<i class="fa-solid ${cfg.placeholderIcon} text-sm drop-shadow-sm"></i>`;
          iconEl.className = "w-8 h-8 rounded-lg bg-gradient-to-br from-amber-400 via-orange-500 to-rose-500 text-white flex items-center justify-center shadow-sm";
          textEl.textContent = cfg.placeholder;
          textEl.className = "text-slate-400";
          return;
        }

        iconEl.innerHTML = `<i class="fa-solid ${cfg.placeholderIcon} text-sm"></i>`;
        iconEl.className = (key === 'dashUser' || key === 'histUser')
          ? "w-7 h-7 rounded-lg bg-slate-100 text-slate-400 flex items-center justify-center border border-slate-200"
          : "w-8 h-8 rounded-lg bg-slate-100 text-slate-400 flex items-center justify-center border border-slate-200";
        textEl.textContent = cfg.placeholder;
        textEl.className = "text-slate-400";
        return;
      }

      // UI only: keep Payment Method icon in the same orange tone as Category trigger icon
      if(key === 'payMethod'){
        iconEl.innerHTML = `<i class="fa-solid ${found.icon} text-sm drop-shadow-sm"></i>`;
        iconEl.className = "w-8 h-8 rounded-lg bg-gradient-to-br from-amber-400 via-orange-500 to-rose-500 text-white flex items-center justify-center shadow-sm";
      } else {
        iconEl.innerHTML = `<i class="fa-solid ${found.icon} text-blue-600"></i>`;
        iconEl.className = (key === 'dashUser' || key === 'histUser')
          ? "w-7 h-7 rounded-lg bg-blue-50 flex items-center justify-center border border-blue-100"
          : "w-8 h-8 rounded-lg bg-blue-50 flex items-center justify-center border border-blue-100";
      }
      textEl.textContent = found.label;
      textEl.className = "text-slate-900 font-bold";
    }

    // ===========================================
    // Loading & Utils
    // ===========================================
    function showLoading(title, sub) {
      __loadingCount++;
      const o = document.getElementById('loadingOverlay');
      const t = document.getElementById('loadingTitle');
      const s = document.getElementById('loadingSub');
      if (t) t.textContent = title || 'Loading‚Ä¶';
      if (s) s.textContent = sub || 'Please wait';
      if (o) { o.classList.remove('hidden'); document.body.style.overflow = 'hidden'; }
    }

    function hideLoading() {
      __loadingCount = Math.max(0, __loadingCount - 1);
      if (__loadingCount > 0) return;
      const o = document.getElementById('loadingOverlay');
      if (o) { o.classList.add('hidden'); document.body.style.overflow = ''; }
    }

    function ymdLocal(d) {
      const yyyy = d.getFullYear();
      const mm = String(d.getMonth() + 1).padStart(2, '0');
      const dd = String(d.getDate()).padStart(2, '0');
      return `${yyyy}-${mm}-${dd}`;
    }

    function initDateDefaultToday() {
      const el = document.getElementById('txDate');
      if (el && !el.value) el.value = ymdLocal(new Date());
    }

    function initYearSelector(selectId){
      const sel = document.getElementById(selectId);
      if (!sel) return;
      const now = new Date();
      const currentYear = now.getFullYear();
      const start = currentYear - 5;
      const end = currentYear + 1;
      sel.innerHTML = '';
      for (let y = end; y >= start; y--) {
        const opt = document.createElement('option');
        opt.value = String(y);
        opt.textContent = String(y);
        sel.appendChild(opt);
      }
      sel.value = String(currentYear);
    }

    function bindGlobalRefresh(){
      document.getElementById('btnQuickRefresh').addEventListener('click', () => refreshDashboard());
    }

    let __activeTab = 'input';
    let __historyCache = [];

    function setTabBtnState(btn, isActive){
      if (!btn) return;
      btn.classList.toggle('tab-active', isActive);
      btn.classList.toggle('tab-inactive', !isActive);
    }

    function switchTab(tab) {
      __activeTab = tab;
      const input = document.getElementById('tab-input');
      const dash = document.getElementById('tab-dashboard');
      const hist = document.getElementById('tab-history');
      const bInput = document.getElementById('tabBtnInput');
      const bDash = document.getElementById('tabBtnDash');
      const bHist = document.getElementById('tabBtnHistory');

      if (input) input.classList.toggle('hidden', tab !== 'input');
      if (dash)  dash.classList.toggle('hidden', tab !== 'dashboard');
      if (hist)  hist.classList.toggle('hidden', tab !== 'history');

      setTabBtnState(bInput, tab === 'input');
      setTabBtnState(bDash, tab === 'dashboard');
      setTabBtnState(bHist, tab === 'history');

      if (tab === 'dashboard') refreshDashboard();
      if (tab === 'history') refreshHistory();
    }

    function bindDashboardControls() {
      document.getElementById('dashUser').addEventListener('change', refreshDashboard);
      document.getElementById('dashYear').addEventListener('change', refreshDashboard);
      document.getElementById('btnRefresh').addEventListener('click', refreshDashboard);
    }

    function bindHistoryControls(){
      const hu = document.getElementById('histUser');
      const hy = document.getElementById('histYear');
      const br = document.getElementById('btnHistRefresh');
      if (hu) hu.addEventListener('change', refreshHistory);
      if (hy) hy.addEventListener('change', refreshHistory);
      if (br) br.addEventListener('click', refreshHistory);
    }

    function resetTypeSelection(){
      currentType = '';
      const exp = document.getElementById('btnExp');
      const inc = document.getElementById('btnInc');
      const baseClass = 'type-neutral py-4 rounded-2xl font-bold text-sm transition-all flex flex-col items-center gap-1 group';
      exp.className = baseClass;
      inc.className = baseClass;
    }

    function setType(type) {
      currentType = type;
      const exp = document.getElementById('btnExp');
      const inc = document.getElementById('btnInc');
      const baseClass = 'py-4 rounded-2xl font-bold text-sm transition-all flex flex-col items-center gap-1 group ';
      if (type === 'Expense') {
        exp.className = baseClass + 'type-active-exp';
        inc.className = baseClass + 'type-neutral';
      } else {
        exp.className = baseClass + 'type-neutral';
        inc.className = baseClass + 'type-active-inc';
      }
    }

    function resetUserSelection(){
      const u = document.getElementById('userName');
      if (u) u.value = '';
      syncCustomSelectUI('user');
    }

    // --- Data Fetching ---
    async function refreshDashboard() {
      const user = document.getElementById('dashUser').value;
      const year = Number(document.getElementById('dashYear').value);
      const opts = { user, mode: 'monthly', year };
      showLoading('Loading...', 'Updating Dashboard');
      try {
        const res = await apiCall('getDashboardDataV2', opts);
        updateDashboardV2(res);
      } catch (err) {
        alert('‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: ' + (err && err.message ? err.message : err));
      } finally {
        hideLoading();
      }
    }

    async function refreshHistory(){
      const user = (document.getElementById('histUser') && document.getElementById('histUser').value) ? document.getElementById('histUser').value : 'All';
      const yearVal = (document.getElementById('histYear') && document.getElementById('histYear').value) ? document.getElementById('histYear').value : new Date().getFullYear();
      const year = Number(yearVal);
      const opts = { user, mode: 'monthly', year };
      showLoading('History', 'Fetching transactions...');
      try {
        const res = await apiCall('getDashboardDataV2', opts);
        if (!res || res.ok === false) throw new Error((res && res.error) ? res.error : '‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à');

        let allItems = res.history || [];
        const filteredItems = allItems.filter(item => {
          if (!item.date) return false;
          return String(item.date).includes(String(year));
        });
        __historyCache = filteredItems;
        renderHistory(__historyCache);
      } catch (err) {
        alert('‡πÇ‡∏´‡∏•‡∏î History ‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: ' + (err && err.message ? err.message : err));
      } finally {
        hideLoading();
      }
    }

    async function deleteHistoryItem(row){
      const rowNum = Number(row || 0);
      if (!rowNum) return;
      const ok = confirm('‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ô‡∏µ‡πâ‡πÉ‡∏ä‡πà‡πÑ‡∏´‡∏°?');
      if (!ok) return;
      showLoading('Deleting', 'Removing item...');
      try{
        const res = await apiCall('deleteData', { row: rowNum });
        if (res && res.ok === false) throw new Error(res.error || '‡∏•‡∏ö‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à');
        await refreshHistory();
        await refreshDashboard();
      }catch(err){
        alert('‡∏•‡∏ö‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: ' + (err && err.message ? err.message : err));
      }finally{
        hideLoading();
      }
    }

    function money(x) {
      const n = Number(x || 0);
      return '‡∏ø ' + n.toLocaleString();
    }

    function updateDashboardV2(res) {
      if (!res || res.ok === false) {
        alert((res && res.error) ? res.error : '‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à');
        return;
      }
      document.getElementById('kpiNet').innerText = money(res.period.net);
      // Payment Method breakdown (Cash/Digital)
      const cashNet = (res && res.periodMethods && res.periodMethods.cash) ? Number(res.periodMethods.cash.net || 0) : 0;
      const digitalNet = (res && res.periodMethods && res.periodMethods.digital) ? Number(res.periodMethods.digital.net || 0) : 0;
      const elCash = document.getElementById('kpiNetCash');
      const elDigital = document.getElementById('kpiNetDigital');
      if (elCash) elCash.innerText = money(cashNet);
      if (elDigital) elDigital.innerText = money(digitalNet);
      document.getElementById('kpiSavings').innerText = money(res.period.savings);
      document.getElementById('kpiIncome').innerText = money(res.period.income);
      document.getElementById('kpiExpense').innerText = money(res.period.expense);
      document.getElementById('kpiOverallBalance').innerText = money(res.overall.balance);
      document.getElementById('rangeHint').innerText = `Year: ${res.filter.year}`;

      const currentUser = document.getElementById('dashUser').value;
      renderCharts(res.series, currentUser);

      const yStr = String(res.filter.year);
      const yearFilteredHistory = (res.history || []).filter(x => x.date && String(x.date).includes(yStr));

      // ‚úÖ Donut 1: ‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà‡πÄ‡∏á‡∏¥‡∏ô‡∏≠‡∏≠‡∏°
      const donutData = calculateExpenseDonutData(yearFilteredHistory);
      renderDonutChart(donutData);

      // ‚úÖ Donut 2: ‡∏™‡∏±‡∏î‡∏™‡πà‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô‡∏≠‡∏≠‡∏°‡πÅ‡∏ï‡πà‡∏•‡∏∞‡∏ä‡∏ô‡∏¥‡∏î
      const savingsDonutData = calculateSavingsDonutData(yearFilteredHistory);
      renderSavingsDonutChart(savingsDonutData);

      if(res.history) {
        __historyCache = yearFilteredHistory;
        if (__activeTab === 'history') renderHistory(__historyCache);
      }
    }

    // --- Calculation Functions ---
    function calculateTrendLine(data) {
      let lastIndex = data.length - 1;
      while(lastIndex >= 0 && data[lastIndex] === 0) lastIndex--;
      if (lastIndex < 1) return Array(12).fill(null);

      let x = [], y = [];
      for (let i = 0; i <= lastIndex; i++) { x.push(i); y.push(data[i]); }

      let n = x.length, sumX = 0, sumY = 0, sumXY = 0, sumXX = 0;
      for (let i = 0; i < n; i++) {
        sumX += x[i]; sumY += y[i]; sumXY += x[i]*y[i]; sumXX += x[i]*x[i];
      }
      let slope = (n*sumXY - sumX*sumY) / (n*sumXX - sumX*sumX);
      let intercept = (sumY - slope*sumX) / n;

      let trendData = [];
      for (let i = 0; i < 12; i++) trendData.push(slope*i + intercept);
      return trendData;
    }

    // ‚úÖ Donut ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö "‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢" ‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà‡πÄ‡∏á‡∏¥‡∏ô‡∏≠‡∏≠‡∏°
    function calculateExpenseDonutData(historyItems) {
      const totals = {};
      historyItems.forEach(item => {
        const t = (item.type || '').toString().trim();
        if (t !== '‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢') return;

        const cat = (item.category || '‡∏≠‡∏∑‡πà‡∏ô‡πÜ').toString().trim();
        if (isSavingsCategory(cat)) return; // ‡∏ï‡∏±‡∏î‡πÄ‡∏á‡∏¥‡∏ô‡∏≠‡∏≠‡∏°‡∏≠‡∏≠‡∏Å

        let rawAmt = item.amt;
        if (typeof rawAmt === 'string') rawAmt = rawAmt.replace(/,/g, '');
        const amt = parseFloat(rawAmt) || 0;
        if (!totals[cat]) totals[cat] = 0;
        totals[cat] += amt;
      });
      return totals;
    }

    // ‚úÖ Donut ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö "‡πÄ‡∏á‡∏¥‡∏ô‡∏≠‡∏≠‡∏°" ‡πÅ‡∏¢‡∏Å‡∏ï‡∏≤‡∏°‡∏ä‡∏ô‡∏¥‡∏î (‡∏£‡∏ß‡∏°‡∏ó‡∏∏‡∏Å type ‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡∏°‡∏ß‡∏î‡πÄ‡∏á‡∏¥‡∏ô‡∏≠‡∏≠‡∏°)
    function calculateSavingsDonutData(historyItems) {
      const totals = {};
      historyItems.forEach(item => {
        const cat = (item.category || '').toString().trim();
        if (!isSavingsCategory(cat)) return;

        let rawAmt = item.amt;
        if (typeof rawAmt === 'string') rawAmt = rawAmt.replace(/,/g, '');
        const amt = Math.abs(parseFloat(rawAmt) || 0);
        if (!totals[cat]) totals[cat] = 0;
        totals[cat] += amt;
      });
      return totals;
    }

    // ===========================================
    // BLUE GRADIENT THEME (Charts)
    // ===========================================
    function _blueStops() {
      return [
        '#0b3b9e', '#0d4ac2', '#0f5fe0', '#1673ff',
        '#1b86ff', '#2a9cff', '#34b3ff', '#4cc8ff',
        '#67d9ff', '#86e6ff', '#a5f0ff', '#c3f7ff'
      ];
    }

    function _makeLinearBlue(ctx, area, a1 = 0.95, a2 = 0.25, dir = 'v') {
      const g = (dir === 'h')
        ? ctx.createLinearGradient(area.left, 0, area.right, 0)
        : ctx.createLinearGradient(0, area.top, 0, area.bottom);

      g.addColorStop(0, `rgba(37, 99, 235, ${a1})`);
      g.addColorStop(0.55, `rgba(29, 78, 216, ${(a1 + a2) / 2})`);
      g.addColorStop(1, `rgba(14, 165, 233, ${a2})`);
      return g;
    }

    function _makeLinearBlueSoft(ctx, area, a1 = 0.35, a2 = 0.02) {
      const g = ctx.createLinearGradient(0, area.top, 0, area.bottom);
      g.addColorStop(0, `rgba(37, 99, 235, ${a1})`);
      g.addColorStop(1, `rgba(37, 99, 235, ${a2})`);
      return g;
    }

    // --- Chart Rendering (Chart.js) ---
    function renderCharts(series, currentUser) {
      const labels = MONTH_LABELS.slice();
      const income = series.income || [];
      const expense = series.expense || [];
      const savings = series.savings || [];

      if (barChart) barChart.destroy();
      if (lineChart) lineChart.destroy();

      const fontConfig = { family: "'Kanit', sans-serif", size: 10 };
      const commonOptions = {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          legend: { display: false },
          tooltip: {
            backgroundColor: 'rgba(15, 23, 42, 0.92)',
            padding: 10,
            titleFont: { family: "'Kanit', sans-serif" },
            bodyFont: { family: "'Kanit', sans-serif" },
            cornerRadius: 8,
            displayColors: false
          }
        },
        scales: {
          x: { ticks: { font: fontConfig, color: '#94a3b8' }, grid: { display: false } },
          y: {
            beginAtZero: true,
            ticks: { font: fontConfig, color: '#94a3b8', maxTicksLimit: 5 },
            grid: { color: 'rgba(148, 163, 184, 0.15)', drawBorder: false }
          }
        }
      };

      const barIncomeBg = (context) => {
        const chart = context.chart;
        const { ctx, chartArea } = chart;
        if (!chartArea) return 'rgba(37, 99, 235, 0.85)';
        return _makeLinearBlue(ctx, chartArea, 0.95, 0.25, 'v');
      };

      const barExpenseBg = (context) => {
        const chart = context.chart;
        const { ctx, chartArea } = chart;
        if (!chartArea) return 'rgba(14, 165, 233, 0.70)';
        const g = ctx.createLinearGradient(0, chartArea.top, 0, chartArea.bottom);
        g.addColorStop(0, 'rgba(14, 165, 233, 0.85)');
        g.addColorStop(1, 'rgba(14, 165, 233, 0.25)');
        return g;
      };

      barChart = new Chart(document.getElementById('barChart'), {
        type: 'bar',
        data: {
          labels,
          datasets: [
            { label: 'Income', data: income, backgroundColor: barIncomeBg, borderRadius: 6, borderWidth: 0 },
            { label: 'Expense', data: expense, backgroundColor: barExpenseBg, borderRadius: 6, borderWidth: 0 }
          ]
        },
        options: commonOptions
      });

      let targetValue = 0;
      if (currentUser === 'Nine') targetValue = targetNine;
      else if (currentUser === 'Bow') targetValue = targetBow;
      else targetValue = targetNine + targetBow;

      const targetData = labels.map(() => targetValue);
      const trendData = calculateTrendLine(savings);

      let lastSaveIndex = savings.length - 1;
      while (lastSaveIndex >= 0 && savings[lastSaveIndex] === 0) lastSaveIndex--;

      const emojiEl = document.getElementById('trendEmoji');
      if (targetValue > 0 && lastSaveIndex >= 0) {
        const currentSaving = savings[lastSaveIndex];
        if (currentSaving >= targetValue) {
          emojiEl.innerHTML = '<i class="fa-regular fa-face-smile text-emerald-500 text-lg"></i>';
        } else {
          emojiEl.innerHTML = '<i class="fa-regular fa-face-frown text-rose-500 text-lg"></i>';
        }
      } else {
        emojiEl.innerHTML = '';
      }

      const savingsFill = (context) => {
        const chart = context.chart;
        const { ctx, chartArea } = chart;
        if (!chartArea) return 'rgba(37, 99, 235, 0.15)';
        return _makeLinearBlueSoft(ctx, chartArea, 0.25, 0.02);
      };

      lineChart = new Chart(document.getElementById('lineChart'), {
        type: 'line',
        data: {
          labels,
          datasets: [
            {
              label: 'Savings',
              data: savings,
              tension: 0.4,
              borderColor: 'rgba(37, 99, 235, 0.95)',
              borderWidth: 2,
              backgroundColor: savingsFill,
              pointBackgroundColor: '#ffffff',
              pointBorderColor: 'rgba(37, 99, 235, 0.95)',
              pointBorderWidth: 2,
              pointRadius: 3,
              fill: true
            },
            {
              label: 'Min Goal',
              data: targetData,
              borderColor: 'rgba(34, 197, 94, 1)', // #22c55e
              borderWidth: 2,
              borderDash: [6, 6],
              pointRadius: 0,
              fill: false,
              tension: 0
            },
            {
              label: 'Trend',
              data: trendData,
              borderColor: 'rgba(14, 165, 233, 0.70)',
              borderWidth: 2,
              borderDash: [2, 4],
              pointRadius: 0,
              fill: false,
              tension: 0
            }
          ]
        },
        options: commonOptions
      });
    }

function renderDonutChart(dataObj) {
    const labels = Object.keys(dataObj);
    const data = Object.values(dataObj);
    const total = data.reduce((a, b) => a + b, 0);

    const canvas = document.getElementById('donutChart');
    if (donutChart) donutChart.destroy();
    if (!canvas || data.length === 0) return;

    const colors = _expensePinkToRedStops();

    donutChart = new Chart(canvas, {
      type: 'doughnut',
      data: {
        labels: labels,
        datasets: [{
          data: data,
          backgroundColor: labels.map((_, i) => colors[i % colors.length]),
          borderWidth: 0,
          hoverOffset: 10
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        layout: { padding: { top: 10, bottom: 10 } },
        plugins: {
          legend: {
            position: 'right',
            labels: {
              font: { family: "'Kanit', sans-serif", size: 10 },
              boxWidth: 10,
              padding: 15,
              color: 'rgba(203, 213, 225, 0.88)'
            }
          },
          tooltip: {
            backgroundColor: 'rgba(15, 23, 42, 0.92)',
            padding: 12,
            titleFont: { family: "'Kanit', sans-serif", size: 13 },
            bodyFont: { family: "'Kanit', sans-serif", size: 12 },
            cornerRadius: 10,
            callbacks: {
              label: function(context) {
                const label = context.label || '';
                const value = context.raw || 0;
                const pct = total > 0 ? ((value / total) * 100).toFixed(1) + '%' : '0%';
                return ` ${label}: ‡∏ø${Number(value).toLocaleString()} (${pct})`;
              }
            }
          }
        }
      }
    });
  }

  // ‚úÖ Replace ‡πÄ‡∏î‡∏¥‡∏°: Savings By Type donut (‡∏ü‡πâ‡∏≤‡∏≠‡πà‡∏≠‡∏ô -> ‡∏ü‡πâ‡∏≤‡πÄ‡∏Ç‡πâ‡∏°)
  function renderSavingsDonutChart(dataObj) {
    const labels = Object.keys(dataObj);
    const data = Object.values(dataObj);
    const total = data.reduce((a, b) => a + b, 0);

    const canvas = document.getElementById('savingsDonutChart');
    if (!canvas) return;

    if (savingsDonutChart) savingsDonutChart.destroy();
    if (data.length === 0) return;

    const colors = _savingsLightBlueToDeepStops();

    savingsDonutChart = new Chart(canvas, {
      type: 'doughnut',
      data: {
        labels: labels,
        datasets: [{
          data: data,
          backgroundColor: labels.map((_, i) => colors[i % colors.length]),
          borderWidth: 0,
          hoverOffset: 10
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        layout: { padding: { top: 10, bottom: 10 } },
        plugins: {
          legend: {
            position: 'right',
            labels: {
              font: { family: "'Kanit', sans-serif", size: 10 },
              boxWidth: 10,
              padding: 15,
              color: 'rgba(203, 213, 225, 0.88)'
            }
          },
          tooltip: {
            backgroundColor: 'rgba(15, 23, 42, 0.92)',
            padding: 12,
            titleFont: { family: "'Kanit', sans-serif", size: 13 },
            bodyFont: { family: "'Kanit', sans-serif", size: 12 },
            cornerRadius: 10,
            callbacks: {
              label: function(context) {
                const label = context.label || '';
                const value = context.raw || 0;
                const pct = total > 0 ? ((value / total) * 100).toFixed(1) + '%' : '0%';
                return ` ${label}: ‡∏ø${Number(value).toLocaleString()} (${pct})`;
              }
            }
          }
        }
      }
    });
  }
        function renderHistory(items) {
      const sortedItems = items.slice().sort((a, b) => Number(b.row) - Number(a.row));

      let html = '';
      sortedItems.forEach((item) => {
        const isIncome = item.type === '‡∏£‡∏≤‡∏¢‡∏£‡∏±‡∏ö';
        const amtColor = isIncome ? 'text-emerald-600' : 'text-rose-600';
        const iconBg = isIncome ? 'bg-emerald-100 text-emerald-600 border border-emerald-200/60' : 'bg-rose-100 text-rose-600 border border-rose-200/60';
        const sign = isIncome ? '+' : '-';

        let catIcon = '<i class="fa-solid fa-tag"></i>';
        const c = String(item.category || '');
        if(c.includes('‡∏≠‡∏≤‡∏´‡∏≤‡∏£')) catIcon = '<i class="fa-solid fa-utensils"></i>';
        else if(c.includes('‡πÄ‡∏î‡∏¥‡∏ô‡∏ó‡∏≤‡∏á')) catIcon = '<i class="fa-solid fa-gas-pump"></i>';
        else if(c.includes('‡∏ó‡∏µ‡πà‡∏û‡∏±‡∏Å')) catIcon = '<i class="fa-solid fa-house"></i>';
        else if(c.includes('‡∏ä‡πâ‡∏≠‡∏õ‡∏õ‡∏¥‡πâ‡∏á')) catIcon = '<i class="fa-solid fa-bag-shopping"></i>';
        else if(c.includes('‡πÄ‡∏á‡∏¥‡∏ô‡∏≠‡∏≠‡∏°‡πÅ‡∏ö‡∏ö‡πÄ‡∏á‡∏¥‡∏ô‡∏ï‡∏£‡∏≤‡πÑ‡∏ó‡∏¢ THB')) catIcon = '<i class="fa-solid fa-piggy-bank"></i>';
        else if(c.includes('‡πÄ‡∏á‡∏¥‡∏ô‡∏≠‡∏≠‡∏°‡πÅ‡∏ö‡∏ö‡πÄ‡∏á‡∏¥‡∏ô‡∏ï‡∏£‡∏≤‡∏ï‡πà‡∏≤‡∏á‡∏õ‡∏£‡∏∞‡πÄ‡∏ó‡∏® USD')) catIcon = '<i class="fa-solid fa-dollar-sign"></i>';
        else if(c.includes('‡∏õ‡∏£‡∏∞‡∏Å‡∏±‡∏ô‡∏™‡∏∞‡∏™‡∏°‡∏ó‡∏£‡∏±‡∏û‡∏¢‡πå')) catIcon = '<i class="fa-solid fa-shield-halved"></i>';
        else if(c.includes('‡∏≠‡∏≠‡∏°‡∏ó‡∏≠‡∏á')) catIcon = '<i class="fa-solid fa-coins"></i>';
        else if(c.includes('‡∏£‡∏≤‡∏¢‡∏£‡∏±‡∏ö')) catIcon = '<i class="fa-solid fa-money-bill-wave"></i>';

        const rowNum = Number(item.row || 0);
        const canDelete = rowNum > 0;
        const deleteBtn = canDelete
          ? `<button onclick="deleteHistoryItem(${rowNum})" class="w-11 h-11 rounded-full bg-rose-50 text-rose-500 border border-rose-100 shadow-sm flex items-center justify-center transition-all active:scale-90 hover:bg-rose-100 ml-2"><i class="fa-solid fa-trash-can text-lg"></i></button>` : ``;

        html += `
          <div class="bg-white/92 backdrop-blur p-4 rounded-[1.5rem] flex items-center justify-between shadow-sm border border-slate-100 card-hover">
            <div class="flex items-center gap-3 flex-1 min-w-0">
              <div class="w-11 h-11 min-w-[44px] rounded-2xl ${iconBg} flex items-center justify-center text-lg self-start">
                ${catIcon}
              </div>
              <div class="overflow-hidden flex-1">
                <p class="font-bold text-slate-800 text-sm leading-tight truncate pr-2">${escapeHtml(item.category)}</p>
                <div class="flex items-start gap-2 text-[11px] text-slate-400 mt-1">
                  <span class="bg-white/70 border border-slate-200 px-1.5 py-0.5 rounded text-slate-600 font-semibold whitespace-nowrap h-fit mt-0.5">${escapeHtml(item.user)}</span>
                  <span class="break-words whitespace-normal leading-tight flex-1">${escapeHtml(item.desc || '-')}</span>
                </div>
              </div>
            </div>
            <div class="flex items-center pl-2 self-start mt-1">
              <div class="text-right mr-1">
                <p class="font-bold ${amtColor} text-base whitespace-nowrap">${sign}${escapeHtml(item.amt)}</p>
                <span class="text-[10px] text-slate-300 block">${escapeHtml(item.date)}</span>
              </div>
              ${deleteBtn}
            </div>
          </div>`;
      });

      document.getElementById('history-list').innerHTML = html ||
        `<div class="flex flex-col items-center justify-center py-12 text-slate-300">
           <i class="fa-regular fa-folder-open text-4xl mb-2"></i>
           <p class="text-xs">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÉ‡∏ô‡∏õ‡∏µ‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å</p>
         </div>`;
    }

    function escapeHtml(str) {
      return String(str).replace(/[&<>"']/g, (m) => ({ '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#39;' }[m]));
    }

    function resetInputs() {
      document.getElementById('desc').value = '';
      document.getElementById('amt').value = '';
      const pm = document.getElementById('payMethod'); if (pm) { pm.value = ''; try { syncCustomSelectUI('payMethod'); } catch(e) {} }
      resetCustomDropdown();
      resetTypeSelection();
      resetUserSelection();
      initDateDefaultToday();
    }

    async function saveData() {
      const btn = document.getElementById('saveBtn');
      const userVal = document.getElementById('userName').value;
      if (!userVal) return alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å User ‡∏Å‡πà‡∏≠‡∏ô‡∏à‡πâ‡∏≤');
      if (!currentType) return alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢‡∏´‡∏£‡∏∑‡∏≠‡∏£‡∏≤‡∏¢‡∏£‡∏±‡∏ö‡∏Å‡πà‡∏≠‡∏ô‡∏à‡πâ‡∏≤');
      const cateVal = document.getElementById('cate').value;
    
  if (!cateVal) return alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà‡∏Å‡πà‡∏≠‡∏ô‡∏à‡πâ‡∏≤');
            const pmVal = (document.getElementById('payMethod') ? document.getElementById('payMethod').value : '');

      if (!pmVal) return alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ä‡πà‡∏≠‡∏á‡∏ó‡∏≤‡∏á‡πÉ‡∏ä‡πâ‡∏à‡πà‡∏≤‡∏¢‡∏Å‡πà‡∏≠‡∏ô‡∏à‡πâ‡∏≤');
const dateVal = document.getElementById('txDate').value || ymdLocal(new Date());

      const payload = {
        entryDate: dateVal,
        userName: userVal,
        paymentMethod: pmVal,
        type: currentType === 'Expense' ? '‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢' : '‡∏£‡∏≤‡∏¢‡∏£‡∏±‡∏ö',
        category: cateVal,
        description: (document.getElementById('desc').value || '').trim(),
        amount: document.getElementById('amt').value
      };
      if (!payload.amount) return alert('‡∏Å‡∏£‡∏≠‡∏Å ‚Äú‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô‚Äù ‡∏Å‡πà‡∏≠‡∏ô‡∏à‡πâ‡∏≤');

      showLoading('Saving', 'Writing data...');
      btn.disabled = true;
      try {
        const res = await apiCall('addData', payload);
        updateDashboardV2(res);
        switchTab('dashboard');
        resetInputs();
      } catch (err) {
        alert('‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: ' + (err && err.message ? err.message : err));
      } finally {
        hideLoading();
        btn.disabled = false;
      }
    }
  </script>
</body>
</html>
