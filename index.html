<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8" />
  
  <link rel="icon" type="image/png" sizes="32x32" href="favicon-32.png">
  <link rel="icon" type="image/png" sizes="16x16" href="favicon-16.png">
  <link rel="apple-touch-icon" sizes="180x180" href="apple-touch-icon.png">
  <link rel="manifest" href="manifest.webmanifest">
  <meta name="theme-color" content="#020617">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="My Piggy">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover" />

  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;500;600&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

  <style>
    :root{
      --bg:#f6f7fb;
      --bg2:#eef2ff;
      --card: rgba(255,255,255,.82);
      --card2: rgba(255,255,255,.92);
      --stroke: rgba(15,23,42,.08);
      --text:#0f172a;
      --muted:#64748b;
      --muted2:#94a3b8;

      --accent:#2563eb;
      --accent2:#06b6d4;

      --good:#10b981;
      --bad:#ef4444;
      --ring: rgba(37,99,235,.18);
    }

    * { -webkit-tap-highlight-color: transparent; }
    body{
      font-family:'Kanit',sans-serif;
      color: var(--text);
      background:
        radial-gradient(900px 600px at 15% 0%, rgba(37,99,235,.12), transparent 60%),
        radial-gradient(900px 600px at 90% 10%, rgba(6,182,212,.10), transparent 55%),
        radial-gradient(700px 520px at 70% 95%, rgba(16,185,129,.08), transparent 60%),
        linear-gradient(180deg, var(--bg), var(--bg2));
      min-height: 100vh;
    }

    body:before{
      content:"";
      position: fixed;
      inset: 0;
      pointer-events: none;
      background-image:
        linear-gradient(to right, rgba(15,23,42,.045) 1px, transparent 1px),
        linear-gradient(to bottom, rgba(15,23,42,.045) 1px, transparent 1px);
      background-size: 48px 48px;
      mask-image: radial-gradient(closest-side at 50% 10%, black, transparent 70%);
      opacity: .7;
    }

    .glass{
      background: linear-gradient(180deg, var(--card2), var(--card));
      border: 1px solid var(--stroke);
      box-shadow:
        0 18px 45px rgba(2,6,23,.08),
        inset 0 1px 0 rgba(255,255,255,.75);
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
    }

    .chip{
      background: rgba(255,255,255,.85);
      border: 1px solid rgba(15,23,42,.08);
      color: var(--muted);
    }

    .btn{
      border: 1px solid rgba(15,23,42,.10);
      background: rgba(255,255,255,.92);
      color: var(--text);
      box-shadow: 0 12px 30px rgba(2,6,23,.08);
      transition: transform .12s ease, background .2s ease, border-color .2s ease;
    }
    .btn:hover{ border-color: rgba(37,99,235,.22); }
    .btn:active{ transform: scale(.97); }

    .btn-primary{
      border: 1px solid rgba(37,99,235,.25);
      background: linear-gradient(135deg, rgba(37,99,235,.10), rgba(6,182,212,.08));
    }

    .tab-active{
      background: linear-gradient(135deg, rgba(37,99,235,.14), rgba(6,182,212,.10));
      border: 1px solid rgba(37,99,235,.24);
      color: #0b1224;
      box-shadow: 0 12px 28px rgba(37,99,235,.10);
    }
    .tab-inactive{
      background: rgba(255,255,255,.86);
      border: 1px solid rgba(15,23,42,.08);
      color: rgba(15,23,42,.70);
    }

    .type-active-exp{
      background: linear-gradient(135deg, rgba(239,68,68,.12), rgba(244,63,94,.08)) !important;
      border-color: rgba(239,68,68,.22) !important;
      color: #991b1b !important;
      box-shadow: 0 10px 22px rgba(239,68,68,.08);
    }
    .type-active-inc{
      background: linear-gradient(135deg, rgba(16,185,129,.12), rgba(34,197,94,.08)) !important;
      border-color: rgba(16,185,129,.22) !important;
      color: #065f46 !important;
      box-shadow: 0 10px 22px rgba(16,185,129,.08);
    }

    .field{
      background: rgba(255,255,255,.92);
      border: 1px solid rgba(15,23,42,.10);
      color: var(--text);
      outline: none;
      transition: border-color .2s ease, box-shadow .2s ease, background .2s ease;
    }
    .field::placeholder{ color: rgba(100,116,139,.85); }
    .field:focus{
      border-color: rgba(37,99,235,.35);
      box-shadow: 0 0 0 4px var(--ring);
    }

    .muted{ color: rgba(100,116,139,.95); }
    .muted2{ color: rgba(148,163,184,.95); }

    .type-neutral{
      background: rgba(255,255,255,.92);
      border: 1px dashed rgba(15,23,42,.18);
      color: rgba(15,23,42,.65);
    }

    #history-list {
      display: flex;
      flex-direction: column;
      gap: 12px;
    }
  </style>
</head>

<body class="p-4 pb-10">
  <div class="max-w-md mx-auto space-y-5 relative">

    <div class="glass rounded-[2.2rem] p-5">
      <div class="flex items-center justify-between">
        <div class="space-y-0.5">
          <div class="flex items-center gap-2">
            <div class="w-9 h-9 rounded-2xl flex items-center justify-center"
                 style="background:linear-gradient(135deg, rgba(37,99,235,.12), rgba(6,182,212,.10)); border:1px solid rgba(37,99,235,.18);">
              <i class="fa-solid fa-wallet text-sm" style="color:#1d4ed8;"></i>
            </div>
            <div>
              <h1 class="text-lg font-extrabold leading-tight">My Piggy</h1>
              <p class="text-xs muted">Nine & Bow</p>
            </div>
          </div>
        </div>

        <button id="btnQuickRefresh" class="btn btn-primary px-3 py-2 rounded-2xl text-xs font-bold">
          <i class="fa-solid fa-rotate-right mr-1"></i> Refresh
        </button>
      </div>

      <div class="mt-4 grid grid-cols-3 gap-2 p-2 rounded-2xl"
           style="background:rgba(15,23,42,.03); border:1px solid rgba(15,23,42,.06);">
        <button id="tabBtnInput" class="py-2 rounded-xl font-bold tab-active" onclick="switchTab('input')">
          <i class="fa-solid fa-pen-to-square mr-1"></i> Input
        </button>
        <button id="tabBtnDash" class="py-2 rounded-xl font-bold tab-inactive" onclick="switchTab('dashboard')">
          <i class="fa-solid fa-chart-line mr-1"></i> Dashboard
        </button>
        <button id="tabBtnHistory" class="py-2 rounded-xl font-bold tab-inactive" onclick="switchTab('history')">
          <i class="fa-solid fa-clock-rotate-left mr-1"></i> History
        </button>
      </div>
    </div>

    <div id="tab-input" class="space-y-5">
      <div class="glass rounded-[2.2rem] p-6 space-y-4">
        <div class="flex items-center justify-between gap-3 mb-2">
          <div>
            <h3 class="font-extrabold text-lg">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</h3>
            
          </div>

          <div class="flex items-center gap-2">
            <div class="text-right">
              <p class="text-[10px] muted2 mb-1">Date</p>
              <div class="relative">
                <i class="fa-regular fa-calendar absolute left-3 top-1/2 -translate-y-1/2 text-slate-400 text-xs"></i>
                <input
                  type="date"
                  id="txDate"
                  class="field text-xs rounded-full pl-8 pr-3 py-1 w-[160px]"
                />
              </div>
            </div>

            <div class="text-right">
              <p class="text-[10px] muted2 mb-1">User</p>
              <select id="userName" class="field text-xs rounded-full px-3 py-1" required>
                <option value="" selected disabled>-</option>
                <option value="Nine">üë¶ Nine</option>
                <option value="Bow">üëß Bow</option>
              </select>
            </div>
          </div>
        </div>

        <div class="grid grid-cols-2 gap-3">
          <button onclick="setType('Expense')" id="btnExp"
                  class="type-neutral py-3 rounded-2xl font-bold transition-all">
            ‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢
          </button>
          <button onclick="setType('Income')" id="btnInc"
                  class="type-neutral py-3 rounded-2xl font-bold transition-all">
            ‡∏£‡∏≤‡∏¢‡∏£‡∏±‡∏ö
          </button>
        </div>

        <div class="text-[11px] muted -mt-1">
          * ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å User ‡πÅ‡∏•‡∏∞‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢/‡∏£‡∏≤‡∏¢‡∏£‡∏±‡∏ö‡∏Å‡πà‡∏≠‡∏ô‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å
        </div>

        <select id="cate" class="field w-full p-4 rounded-2xl" required>
          <option value="" selected disabled>‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà</option>
          <option value="üç± ‡∏≠‡∏≤‡∏´‡∏≤‡∏£/‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏î‡∏∑‡πà‡∏°">üç± ‡∏≠‡∏≤‡∏´‡∏≤‡∏£/‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏î‡∏∑‡πà‡∏°</option>
          <option value="üöó ‡∏Å‡∏≤‡∏£‡πÄ‡∏î‡∏¥‡∏ô‡∏ó‡∏≤‡∏á">üöó ‡∏Å‡∏≤‡∏£‡πÄ‡∏î‡∏¥‡∏ô‡∏ó‡∏≤‡∏á</option>
          <option value="üè† ‡∏ó‡∏µ‡πà‡∏û‡∏±‡∏Å/‡∏Ç‡∏≠‡∏á‡πÉ‡∏ä‡πâ">üè† ‡∏ó‡∏µ‡πà‡∏û‡∏±‡∏Å/‡∏Ç‡∏≠‡∏á‡πÉ‡∏ä‡πâ</option>
          <option value="üõçÔ∏è ‡∏ä‡πâ‡∏≠‡∏õ‡∏õ‡∏¥‡πâ‡∏á">üõçÔ∏è ‡∏ä‡πâ‡∏≠‡∏õ‡∏õ‡∏¥‡πâ‡∏á</option>
          <option value="üí∞ ‡πÄ‡∏á‡∏¥‡∏ô‡πÄ‡∏Å‡πá‡∏ö/‡∏≠‡∏≠‡∏°‡πÄ‡∏á‡∏¥‡∏ô">üí∞ ‡πÄ‡∏á‡∏¥‡∏ô‡πÄ‡∏Å‡πá‡∏ö/‡∏≠‡∏≠‡∏°‡πÄ‡∏á‡∏¥‡∏ô</option>
          <option value="üíµ ‡∏£‡∏≤‡∏¢‡∏£‡∏±‡∏ö/‡πÇ‡∏ö‡∏ô‡∏±‡∏™">üíµ ‡∏£‡∏≤‡∏¢‡∏£‡∏±‡∏ö/‡πÇ‡∏ö‡∏ô‡∏±‡∏™</option>
          <option value="‚öôÔ∏è ‡∏≠‡∏∑‡πà‡∏ô‡πÜ">‚öôÔ∏è ‡∏≠‡∏∑‡πà‡∏ô‡πÜ</option>
        </select>

        <input
          type="text"
          id="desc"
          class="field w-full p-4 rounded-2xl"
          placeholder="‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£... (‡πÑ‡∏°‡πà‡∏à‡∏≥‡πÄ‡∏õ‡πá‡∏ô‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏£‡∏≠‡∏Å)"
        >
        
        <div class="relative">
          <div class="absolute left-4 top-1/2 -translate-y-1/2 text-[11px] chip px-2 py-1 rounded-xl">
            AMOUNT
          </div>
          <input type="number" id="amt" inputmode="decimal"
                 class="field w-full p-4 pl-24 rounded-2xl text-xl font-extrabold"
                 style="color:#1d4ed8;"
                 placeholder="0.00">
        </div>

        <button onclick="saveData()" id="saveBtn"
                class="btn btn-primary w-full font-extrabold py-4 rounded-2xl">
          <i class="fa-solid fa-floppy-disk mr-2"></i> ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
        </button>

        <div class="text-[11px] muted leading-relaxed">
          * ‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏£‡∏≠‡∏Å ‚Äú‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô‚Äù ‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô
        </div>
      </div>
    </div>

    <div id="tab-dashboard" class="space-y-5 hidden">

      <div class="glass rounded-[2.2rem] p-6 space-y-4">
        <div class="flex items-center justify-between">
          <div>
            <h2 class="text-lg font-extrabold">Dashboard</h2>
            <p class="text-xs muted">Monthly (Jan‚ÄìDec) + ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏õ‡∏µ‡πÑ‡∏î‡πâ</p>
          </div>
          <button id="btnRefresh" class="btn btn-primary px-3 py-2 rounded-2xl text-xs font-bold">
            <i class="fa-solid fa-rotate-right mr-1"></i> Refresh
          </button>
        </div>

        <div class="grid grid-cols-2 gap-3">
          <div class="rounded-2xl p-3" style="background:rgba(15,23,42,.03); border:1px solid rgba(15,23,42,.06);">
            <p class="text-[11px] muted2 mb-1">User</p>
            <select id="dashUser" class="field w-full rounded-xl px-3 py-2 text-sm">
              <option value="All">üåç All</option>
              <option value="Nine">üë¶ Nine</option>
              <option value="Bow">üëß Bow</option>
            </select>
          </div>

          <div class="rounded-2xl p-3" style="background:rgba(15,23,42,.03); border:1px solid rgba(15,23,42,.06);">
            <p class="text-[11px] muted2 mb-1">Year</p>
            <select id="dashYear" class="field w-full rounded-xl px-3 py-2 text-sm"></select>
          </div>
        </div>

        <div class="grid grid-cols-2 gap-4">
          <div class="rounded-[2rem] p-5"
               style="background:linear-gradient(135deg, rgba(37,99,235,.14), rgba(6,182,212,.10)); border:1px solid rgba(37,99,235,.18); box-shadow:0 18px 45px rgba(37,99,235,.10);">
            <p class="text-xs text-slate-700/80">‡∏¢‡∏≠‡∏î‡∏™‡∏∏‡∏ó‡∏ò‡∏¥ (‡∏õ‡∏µ‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å)</p>
            <h2 id="kpiNet" class="text-2xl font-extrabold text-slate-900">‡∏ø 0</h2>
            <p class="text-[10px] text-slate-700/70 mt-1">Income - Expense</p>
          </div>

          <div class="rounded-[2rem] p-5"
               style="background:rgba(255,255,255,.92); border:1px solid rgba(15,23,42,.08);">
            <p class="text-xs muted">‡πÄ‡∏á‡∏¥‡∏ô‡πÄ‡∏Å‡πá‡∏ö‡∏£‡∏ß‡∏° (‡∏õ‡∏µ‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å)</p>
            <h2 id="kpiSavings" class="text-2xl font-extrabold" style="color:#059669;">‡∏ø 0</h2>
            <p class="text-[10px] muted mt-1">‡∏´‡∏°‡∏ß‡∏î ‚Äú‡πÄ‡∏á‡∏¥‡∏ô‡πÄ‡∏Å‡πá‡∏ö/‡∏≠‡∏≠‡∏°‡πÄ‡∏á‡∏¥‡∏ô‚Äù</p>
          </div>
        </div>

        <div class="grid grid-cols-3 gap-3">
          <div class="rounded-2xl p-3" style="background:rgba(255,255,255,.92); border:1px solid rgba(15,23,42,.08);">
            <p class="text-[10px] muted2">Year Income</p>
            <p id="kpiIncome" class="text-sm font-extrabold" style="color:#059669;">‡∏ø 0</p>
          </div>
          <div class="rounded-2xl p-3" style="background:rgba(255,255,255,.92); border:1px solid rgba(15,23,42,.08);">
            <p class="text-[10px] muted2">Year Expense</p>
            <p id="kpiExpense" class="text-sm font-extrabold" style="color:#dc2626;">‡∏ø 0</p>
          </div>
          <div class="rounded-2xl p-3" style="background:rgba(255,255,255,.92); border:1px solid rgba(15,23,42,.08);">
            <p class="text-[10px] muted2">Overall Balance</p>
            <p id="kpiOverallBalance" class="text-sm font-extrabold text-slate-900">‡∏ø 0</p>
          </div>
        </div>
      </div>

      <div class="glass rounded-[2.2rem] p-6 space-y-4">
        <div class="flex items-center justify-between">
          <h3 class="font-extrabold text-slate-900">Income vs Expense (Monthly)</h3>
          <span id="rangeHint" class="text-[11px] muted">‚Äî</span>
        </div>

        <div class="rounded-2xl p-3" style="background:rgba(15,23,42,.03); border:1px solid rgba(15,23,42,.06);">
          <canvas id="barChart" height="170"></canvas>
        </div>

        <div class="flex items-center justify-between pt-1">
          <h3 class="font-extrabold text-slate-900">Savings (Monthly)</h3>
          <span class="text-[11px] muted">Jan‚ÄìDec</span>
        </div>

        <div class="rounded-2xl p-3" style="background:rgba(15,23,42,.03); border:1px solid rgba(15,23,42,.06);">
          <canvas id="lineChart" height="150"></canvas>
        </div>
      </div>
    </div>

    <div id="tab-history" class="space-y-5 hidden">

      <div class="glass rounded-[2.2rem] p-6 space-y-6">
        <div class="flex items-center justify-between pb-4 mb-2" style="border-bottom:1px solid rgba(15,23,42,.06);">
          <div>
            <h2 class="text-lg font-extrabold">History</h2>
            <p class="text-xs muted">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î + ‡∏•‡∏ö‡πÑ‡∏î‡πâ</p>
          </div>

          <button id="btnHistRefresh" class="btn btn-primary px-3 py-2 rounded-2xl text-xs font-bold">
            <i class="fa-solid fa-rotate-right mr-1"></i> Refresh
          </button>
        </div>

        <div class="grid grid-cols-2 gap-3">
          <div class="rounded-2xl p-3" style="background:rgba(15,23,42,.03); border:1px solid rgba(15,23,42,.06);">
            <p class="text-[11px] muted2 mb-1">User</p>
            <select id="histUser" class="field w-full rounded-xl px-3 py-2 text-sm">
              <option value="All">üåç All</option>
              <option value="Nine">üë¶ Nine</option>
              <option value="Bow">üëß Bow</option>
            </select>
          </div>

          <div class="rounded-2xl p-3" style="background:rgba(15,23,42,.03); border:1px solid rgba(15,23,42,.06);">
            <p class="text-[11px] muted2 mb-1">Year</p>
            <select id="histYear" class="field w-full rounded-xl px-3 py-2 text-sm"></select>
          </div>
        </div>
      </div>

      <div class="space-y-3">
        <h3 class="font-bold ml-2 text-slate-800">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î</h3>
        <div id="history-list"></div>
      </div>

    </div>

    <div id="loadingOverlay" class="fixed inset-0 z-[9999] hidden">
      <div class="absolute inset-0 bg-slate-900/25 backdrop-blur-sm"></div>
      <div class="relative h-full w-full flex items-center justify-center p-6">
        <div class="glass w-full max-w-xs rounded-3xl p-5">
          <div class="flex items-center gap-4">
            <div class="w-10 h-10 rounded-2xl flex items-center justify-center"
                 style="background:linear-gradient(135deg, rgba(37,99,235,.12), rgba(6,182,212,.10)); border:1px solid rgba(37,99,235,.18);">
              <div class="w-6 h-6 border-4 border-blue-600 border-t-transparent rounded-full animate-spin"></div>
            </div>
            <div>
              <p class="text-sm font-extrabold text-slate-900" id="loadingTitle">Loading‚Ä¶</p>
              <p class="text-[11px] muted" id="loadingSub">Please wait</p>
            </div>
          </div>
        </div>
      </div>
    </div>

  </div>

  <script>
    // =========================
    // GitHub Pages Mode: Hardcoded API URL
    // =========================
    const API_URL = 'https://script.google.com/macros/s/AKfycbzoOjvgoZh32rbSa9Z18bgzRiUeBAr066-1b3qHfcAK_r3jtu_J3Nq0pyoJAGSKwVIzvA/exec';
    
    async function apiCall(action, params) {
      const body = new URLSearchParams();
      body.append('action', action);

      const p = params || {};
      Object.keys(p).forEach(k => body.append(k, p[k] == null ? '' : String(p[k])));

      const resp = await fetch(API_URL, { method: 'POST', body });
      const text = await resp.text();

      let json;
      try { json = JSON.parse(text); }
      catch (e) {
        throw new Error('API ‡∏ï‡∏≠‡∏ö‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà JSON: ' + text.slice(0, 200));
      }
      return json;
    }

    let currentType = ''; 
    let barChart = null;
    let lineChart = null;

    const MONTH_LABELS = ["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"];
    let __loadingCount = 0;

    window.onload = () => {
      bindGlobalRefresh();
      initDateDefaultToday();
      initYearSelector('dashYear');
      initYearSelector('histYear');
      bindDashboardControls();
      bindHistoryControls();

      refreshDashboard();

      resetTypeSelection();
      resetUserSelection();

      switchTab('input');
    };

    // ---------- LOADING ----------
    function showLoading(title, sub) {
      __loadingCount++;
      const o = document.getElementById('loadingOverlay');
      const t = document.getElementById('loadingTitle');
      const s = document.getElementById('loadingSub');
      if (t) t.textContent = title || 'Loading‚Ä¶';
      if (s) s.textContent = sub || 'Please wait';
      if (o) o.classList.remove('hidden');
    }

    function hideLoading() {
      __loadingCount = Math.max(0, __loadingCount - 1);
      if (__loadingCount > 0) return;
      const o = document.getElementById('loadingOverlay');
      if (o) o.classList.add('hidden');
    }

    // ---------- UTILS ----------
    function ymdLocal(d) {
      const yyyy = d.getFullYear();
      const mm = String(d.getMonth() + 1).padStart(2, '0');
      const dd = String(d.getDate()).padStart(2, '0');
      return `${yyyy}-${mm}-${dd}`;
    }

    function initDateDefaultToday() {
      const el = document.getElementById('txDate');
      if (el && !el.value) el.value = ymdLocal(new Date());
    }

    function initYearSelector(selectId){
      const sel = document.getElementById(selectId);
      if (!sel) return;

      const now = new Date();
      const currentYear = now.getFullYear();
      const start = currentYear - 5;
      const end = currentYear + 1;

      sel.innerHTML = '';
      for (let y = end; y >= start; y--) {
        const opt = document.createElement('option');
        opt.value = String(y);
        opt.textContent = String(y);
        sel.appendChild(opt);
      }
      sel.value = String(currentYear);
    }

    function bindGlobalRefresh(){
      document.getElementById('btnQuickRefresh').addEventListener('click', () => refreshDashboard());
    }

    // ---------- TABS ----------
    let __activeTab = 'input';
    let __historyCache = [];

    function setTabBtnState(btn, isActive){
      if (!btn) return;
      btn.classList.toggle('tab-active', isActive);
      btn.classList.toggle('tab-inactive', !isActive);
    }

    function switchTab(tab) {
      __activeTab = tab;

      const input = document.getElementById('tab-input');
      const dash = document.getElementById('tab-dashboard');
      const hist = document.getElementById('tab-history');

      const bInput = document.getElementById('tabBtnInput');
      const bDash = document.getElementById('tabBtnDash');
      const bHist = document.getElementById('tabBtnHistory');

      if (input) input.classList.toggle('hidden', tab !== 'input');
      if (dash)  dash.classList.toggle('hidden', tab !== 'dashboard');
      if (hist)  hist.classList.toggle('hidden', tab !== 'history');

      setTabBtnState(bInput, tab === 'input');
      setTabBtnState(bDash, tab === 'dashboard');
      setTabBtnState(bHist, tab === 'history');

      if (tab === 'dashboard') refreshDashboard();
      if (tab === 'history') refreshHistory();
    }

    // ---------- DASH CONTROLS ----------
    function bindDashboardControls() {
      document.getElementById('dashUser').addEventListener('change', refreshDashboard);
      document.getElementById('dashYear').addEventListener('change', refreshDashboard);
      document.getElementById('btnRefresh').addEventListener('click', refreshDashboard);
    }

    function bindHistoryControls(){
      const hu = document.getElementById('histUser');
      const hy = document.getElementById('histYear');
      const br = document.getElementById('btnHistRefresh');

      if (hu) hu.addEventListener('change', refreshHistory);
      if (hy) hy.addEventListener('change', refreshHistory);
      if (br) br.addEventListener('click', refreshHistory);
    }

    // ---------- INPUT TYPE ----------
    function resetTypeSelection(){
      currentType = '';
      const exp = document.getElementById('btnExp');
      const inc = document.getElementById('btnInc');
      exp.className = 'type-neutral py-3 rounded-2xl font-bold transition-all';
      inc.className = 'type-neutral py-3 rounded-2xl font-bold transition-all';
    }

    function setType(type) {
      currentType = type;

      const exp = document.getElementById('btnExp');
      const inc = document.getElementById('btnInc');

      exp.className = (type === 'Expense')
        ? 'type-active-exp py-3 rounded-2xl border font-bold transition-all'
        : 'type-neutral py-3 rounded-2xl font-bold transition-all';

      inc.className = (type === 'Income')
        ? 'type-active-inc py-3 rounded-2xl border font-bold transition-all'
        : 'type-neutral py-3 rounded-2xl font-bold transition-all';
    }

    function resetUserSelection(){
      const u = document.getElementById('userName');
      if (u) u.value = '';
    }

    // ---------- DASHBOARD LOAD ----------
    async function refreshDashboard() {
      const user = document.getElementById('dashUser').value;
      const year = Number(document.getElementById('dashYear').value);
      const opts = { user, mode: 'monthly', year };

      showLoading('Loading dashboard‚Ä¶', '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÅ‡∏•‡∏∞‡∏™‡∏£‡∏∏‡∏õ‡∏ú‡∏•');

      try {
        const res = await apiCall('getDashboardDataV2', opts);
        updateDashboardV2(res);
      } catch (err) {
        alert('‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: ' + (err && err.message ? err.message : err));
      } finally {
        hideLoading();
      }
    }

    async function refreshHistory(){
      const user = (document.getElementById('histUser') && document.getElementById('histUser').value) ? document.getElementById('histUser').value : 'All';
      const year = Number((document.getElementById('histYear') && document.getElementById('histYear').value) ? document.getElementById('histYear').value : new Date().getFullYear());
      const opts = { user, mode: 'monthly', year };

      showLoading('Loading history‚Ä¶', '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î');

      try {
        const res = await apiCall('getDashboardDataV2', opts);
        if (!res || res.ok === false) throw new Error((res && res.error) ? res.error : '‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à');
        __historyCache = res.history || [];
        renderHistory(__historyCache);
      } catch (err) {
        alert('‡πÇ‡∏´‡∏•‡∏î History ‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: ' + (err && err.message ? err.message : err));
      } finally {
        hideLoading();
      }
    }

    async function deleteHistoryItem(row){
      const rowNum = Number(row || 0);
      if (!rowNum) return;

      const ok = confirm('‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ô‡∏µ‡πâ‡πÉ‡∏ä‡πà‡πÑ‡∏´‡∏°?');
      if (!ok) return;

      showLoading('Deleting‚Ä¶', '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏•‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£');

      try{
        const res = await apiCall('deleteData', { row: rowNum });
        if (res && res.ok === false) throw new Error(res.error || '‡∏•‡∏ö‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à');

        await refreshHistory();
        await refreshDashboard();
      }catch(err){
        alert('‡∏•‡∏ö‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: ' + (err && err.message ? err.message : err));
      }finally{
        hideLoading();
      }
    }

    function money(x) {
      const n = Number(x || 0);
      return '‡∏ø ' + n.toLocaleString();
    }

    function updateDashboardV2(res) {
      if (!res || res.ok === false) {
        alert((res && res.error) ? res.error : '‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à');
        return;
      }

      document.getElementById('kpiNet').innerText = money(res.period.net);
      document.getElementById('kpiSavings').innerText = money(res.period.savings);
      document.getElementById('kpiIncome').innerText = money(res.period.income);
      document.getElementById('kpiExpense').innerText = money(res.period.expense);
      document.getElementById('kpiOverallBalance').innerText = money(res.overall.balance);

      document.getElementById('rangeHint').innerText = `Jan ‚Üí Dec (${res.filter.year})`;

      renderCharts(res.series);

      __historyCache = res.history || [];
      if (__activeTab === 'history') renderHistory(__historyCache);
    }

    function renderCharts(series) {
      const labels = MONTH_LABELS.slice();
      const income = series.income || [];
      const expense = series.expense || [];
      const savings = series.savings || [];

      if (barChart) barChart.destroy();
      if (lineChart) lineChart.destroy();

      const commonOptions = {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          legend: { display: true, labels: { color: 'rgba(15,23,42,.78)' } },
          tooltip: {
            backgroundColor: 'rgba(255,255,255,.98)',
            titleColor: 'rgba(15,23,42,.92)',
            bodyColor: 'rgba(15,23,42,.85)',
            borderColor: 'rgba(15,23,42,.12)',
            borderWidth: 1
          }
        },
        scales: {
          x: { ticks: { color: 'rgba(15,23,42,.65)', maxRotation: 0, autoSkip: false }, grid: { color: 'rgba(15,23,42,.06)' } },
          y: { beginAtZero: true, ticks: { color: 'rgba(15,23,42,.65)' }, grid: { color: 'rgba(15,23,42,.06)' } }
        }
      };

      barChart = new Chart(document.getElementById('barChart'), {
        type: 'bar',
        data: { labels, datasets: [{ label: 'Income', data: income }, { label: 'Expense', data: expense }] },
        options: commonOptions
      });

      lineChart = new Chart(document.getElementById('lineChart'), {
        type: 'line',
        data: {
          labels,
          datasets: [{
            label: 'Savings',
            data: savings,
            tension: 0.35,
            borderColor: '#22c55e',
            backgroundColor: 'rgba(34,197,94,0.22)',
            pointBackgroundColor: '#22c55e',
            pointBorderColor: '#22c55e',
            pointRadius: 3,
            fill: true
          }]
        },
        options: commonOptions
      });
    }

    // ============================================
    // ‚úÖ RENDER HISTORY (SWAPPED DISPLAY)
    // ============================================
    function renderHistory(items) {
      let html = '';
      items.forEach((item) => {
        const isIncome = item.type === '‡∏£‡∏≤‡∏¢‡∏£‡∏±‡∏ö';
        const colorClass = isIncome ? 'text-emerald-600' : 'text-rose-600';
        const bgIndicator = isIncome ? 'bg-emerald-500' : 'bg-rose-500';
        const sign = isIncome ? '+' : '-';
        const icon = item.user === 'Nine' ? 'üë¶' : (item.user === 'Bow' ? 'üëß' : 'üåç');

        const rowNum = Number(item.row || 0);
        const canDelete = rowNum > 0;
        const extraStyle = canDelete ? "" : "opacity:.45;cursor:not-allowed;";
        const aria = canDelete ? "" : 'aria-disabled="true"';
        const onClick = canDelete
          ? ("deleteHistoryItem(" + rowNum + ")")
          : "alert('‡∏õ‡∏∏‡πà‡∏°‡∏•‡∏ö‡∏¢‡∏±‡∏á‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ ‡πÄ‡∏û‡∏£‡∏≤‡∏∞ API ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏™‡πà‡∏á‡∏Ñ‡πà‡∏≤ row ‡∏Å‡∏•‡∏±‡∏ö‡∏°‡∏≤')";

        html += `
          <div class="glass relative overflow-hidden p-4 rounded-[1.5rem] flex justify-between items-center transition-all hover:scale-[1.01] active:scale-[0.99]">
            <div class="absolute left-0 top-0 bottom-0 w-1.5 ${bgIndicator} opacity-80"></div>
            
            <div class="flex items-center gap-4">
              <div class="w-12 h-12 rounded-2xl flex items-center justify-center bg-slate-50 border border-slate-100 shadow-sm text-xl">
                ${icon}
              </div>
              <div class="space-y-0.5">
                <p class="font-bold text-slate-800 text-[15px] leading-tight">
                  ${escapeHtml(item.category || '')}
                </p>
                
                <div class="flex items-center gap-2 text-[11px]">
                  <span class="px-2 py-0.5 rounded-md bg-slate-100 text-slate-600 font-medium truncate max-w-[120px]">
                    ${escapeHtml(item.desc || '') || '‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î'}
                  </span>
                  
                  <span class="text-slate-400"><i class="fa-regular fa-calendar-check mr-1"></i>${escapeHtml(item.date || '')}</span>
                </div>
              </div>
            </div>

            <div class="flex flex-col items-end gap-2">
              <p class="font-black text-lg ${colorClass} tracking-tight">
                ${sign}${escapeHtml(item.amt || '0')}
              </p>
              <button class="flex items-center justify-center w-8 h-8 rounded-full transition-colors hover:bg-rose-50 text-rose-400 hover:text-rose-600 border border-transparent hover:border-rose-100"
                      style="${extraStyle}"
                      ${aria}
                      onclick="${onClick}">
                <i class="fa-solid fa-trash-can text-[10px]"></i>
              </button>
            </div>
          </div>`;
      });

      document.getElementById('history-list').innerHTML =
        html || `
          <div class="text-center py-10">
            <i class="fa-solid fa-folder-open text-slate-200 text-4xl mb-2"></i>
            <p class="text-sm muted">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö</p>
          </div>`;
    }

    function escapeHtml(str) {
      return String(str).replace(/[&<>"']/g, (m) => ({
        '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#39;'
      }[m]));
    }

    function resetInputs() {
      const descEl = document.getElementById('desc');
      const amtEl  = document.getElementById('amt');
      const cateEl = document.getElementById('cate');
      if (descEl) descEl.value = '';
      if (amtEl) amtEl.value = '';
      if (cateEl) cateEl.value = '';
      resetTypeSelection();
      resetUserSelection();
      initDateDefaultToday();
    }

    // ---------- SAVE ----------
    async function saveData() {
      const btn = document.getElementById('saveBtn');
      const userVal = document.getElementById('userName').value;
      if (!userVal) return alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å User ‡∏Å‡πà‡∏≠‡∏ô‡∏à‡πâ‡∏≤');
      if (!currentType) return alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢‡∏´‡∏£‡∏∑‡∏≠‡∏£‡∏≤‡∏¢‡∏£‡∏±‡∏ö‡∏Å‡πà‡∏≠‡∏ô‡∏à‡πâ‡∏≤');

      const cateVal = document.getElementById('cate').value;
      if (!cateVal) return alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà‡∏Å‡πà‡∏≠‡∏ô‡∏à‡πâ‡∏≤');

      const dateVal = document.getElementById('txDate').value || ymdLocal(new Date());
      const payload = {
        entryDate: dateVal,
        userName: userVal,
        type: currentType === 'Expense' ? '‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢' : '‡∏£‡∏≤‡∏¢‡∏£‡∏±‡∏ö',
        category: cateVal,
        description: (document.getElementById('desc').value || '').trim(),
        amount: document.getElementById('amt').value
      };

      if (!payload.amount) return alert('‡∏Å‡∏£‡∏≠‡∏Å ‚Äú‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô‚Äù ‡∏Å‡πà‡∏≠‡∏ô‡∏à‡πâ‡∏≤');

      showLoading('Saving‚Ä¶', '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•');
      btn.disabled = true;
      btn.innerText = '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å...';

      try {
        const res = await apiCall('addData', payload);
        updateDashboardV2(res);
        switchTab('dashboard');
        resetInputs();
      } catch (err) {
        alert('‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: ' + (err && err.message ? err.message : err));
      } finally {
        hideLoading();
        btn.disabled = false;
        btn.innerHTML = '<i class="fa-solid fa-floppy-disk mr-2"></i> ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•';
      }
    }
  </script>
</body>
</html>